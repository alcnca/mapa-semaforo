<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Semáforo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --brand:#0B4F6C;      /* azul institucional */
      --brand-2:#14597a;
      --brand-weak:#e8f1f6; /* fondos suaves */
      --ink:#0f172a;        /* texto principal */
      --muted:#475569;      /* texto secundario */
      --radius:14px;
    }

    html, body { height: 100%; margin: 0; background: #e1eef4; color: var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue"; }
    #map { height: 100vh; }

    /* ---------- tooltips de sucursal ---------- */
    .leaflet-tooltip {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    .sucursal-label {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      text-shadow: 0 1px 0 rgba(255,255,255,.6);
      color: #0f172a !important;
      font-size: 10px;
      font-weight: 700;
    }

    /* ---------- marcador parpadeante ---------- */
    .neon-marker {
      width: 10px; height: 10px;
      background: red; border-radius: 50%;
      box-shadow: 0 0 3px red, 0 0 6px red;
      animation: pulse 1.5s infinite;
      border: 1px solid white;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 1px red, 0 0 3px red; }
      50% { box-shadow: 0 0 5px red, 0 0 10px red; }
      100% { box-shadow: 0 0 1px red, 0 0 3px red; }
    }

    /* ---------- panel de filtros (se muestra después del popup) ---------- */
    .filtros {
      position: absolute; top: 12px; left: 12px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(3px);
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      z-index: 1000; font-size: 13px;
      display: none;
      box-shadow: 0 8px 30px rgba(2,8,23,.08);
      gap: 6px 10px; align-items: center; display: flex; flex-wrap: wrap;
    }
    .filtros label { font-weight: 600; color: var(--muted); }
    .filtros select { margin-left: 6px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#f3f4f6; font-size:12px; border:1px solid #e5e7eb; }
    #ultima-actualizacion { width:100%; margin-top:4px; font-size:12px; color:#334155; }

    /* ---------- botón Home (inferior derecho, junto al zoom) ---------- */
    .floating-right {
      position: absolute;
      right: 12px;
      bottom: 12px; /* alineado con el control de zoom en bottomright */
      z-index: 1100;
      display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
      pointer-events: none; /* deja que el mapa reciba eventos excepto en los hijos */
    }
    .home-btn {
      pointer-events: auto;
      background: white;
      border-radius: 999px;
      width: 44px; height: 44px;
      display: inline-flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 18px rgba(2,8,23,.15);
      cursor: pointer;
      border: 1px solid #e5e7eb;
      transition: transform .08s ease, background .2s ease;
    }
    .home-btn:hover { background: #f8fafc; transform: translateY(-1px); }
    .home-btn svg { width: 20px; height: 20px; fill: var(--ink); }

    /* ---------- POPUP INICIAL (institucional) ---------- */
    .overlay {
      position: fixed; inset: 0; background: rgba(2, 8, 23, 0.45);
      display: flex; align-items: center; justify-content: center;
      z-index: 2000;
    }
    .modal {
      width: min(640px, 92vw);
      background: #fff;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 30px 70px rgba(2,8,23,.35);
      border: 1px solid #e5e7eb;
    }
    .modal__header {
      display: flex; align-items: center; gap: 14px;
      padding: 16px 18px;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color: #fff;
    }
    .modal__logo {
      width: 38px; height: 38px; border-radius: 8px;
      background: rgba(255,255,255,.15);
      display: inline-flex; align-items: center; justify-content: center;
      border: 1px solid rgba(255,255,255,.25);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.15);
    }
    .modal__title {
      margin: 0; line-height: 1.2;
      font-weight: 700; font-size: 18px;
    }
    .modal__subtitle {
      margin: 2px 0 0; font-size: 12px; opacity: .9; font-weight: 500;
    }
    .modal__body {
      padding: 18px;
      background: linear-gradient(#fff, #fff), radial-gradient(1200px 400px at 100% -50px, var(--brand-weak), transparent);
      background-clip: padding-box, border-box;
    }
    .section {
      border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px;
      background: #fff;
    }
    .section + .section { margin-top: 12px; }
    .section h4 { margin: 0 0 8px; font-size: 14px; color: var(--ink); }
    .muted { font-size: 12px; color: var(--muted); }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .field label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 600; }
    .field input[type="text"],
    .field input[type="number"],
    .field select {
      width: 100%; height: 38px; border-radius: 10px; border: 1px solid #e5e7eb; padding: 0 10px;
      font-size: 14px; outline: none;
    }
    .inline { display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
    .hr { height: 1px; background: #e5e7eb; margin: 14px 0; }
    .actions {
      display: flex; justify-content: flex-end; gap: 10px; padding-top: 8px;
    }
    .btn {
      border: 1px solid #e5e7eb;
      background: #f8fafc;
      color: var(--ink);
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600; cursor: pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover { background: #eef2f7; transform: translateY(-1px); }
    .btn.primary {
      border-color: transparent;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color: #fff;
    }
    .btn.primary:hover { filter: brightness(1.05); }

    /* Ocultos */
    .hide { display: none; }

    /* Selects del panel: tipografía consistente */
    select { font-family: inherit; font-size: 13px; }
  </style>
</head>
<body>

<!-- POPUP institucional -->
<div id="overlay" class="overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="titulo-modal">
    <div class="modal__header">
      <div class="modal__logo" aria-hidden="true">
        <!-- Ícono simple institucional -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" opacity="0.95" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2l9 4v6c0 5-3.8 9.7-9 10-5.2-.3-9-5-9-10V6l9-4z" fill="white" opacity=".25"/>
          <path d="M6 10h12v2H6zM6 14h12v2H6z" fill="white"/>
        </svg>
      </div>
      <div>
        <h3 id="titulo-modal" class="modal__title">Configuración inicial</h3>
        <p class="modal__subtitle">Selecciona la cartera y el alcance antes de cargar información</p>
      </div>
    </div>

    <div class="modal__body">
      <div class="section">
        <h4>Cartera a visualizar</h4>
        <div class="grid-2">
          <div class="field">
            <label for="selCartera">Tipo de cartera</label>
            <select id="selCartera">
              <option value="ADMIN">Cartera Administrativa (7–44 días vencidos)</option>
              <option value="EXTRA">Cartera Extrajudicial (≥45 días vencidos)</option>
            </select>
          </div>
          <div class="field">
            <label for="coordInput">Coordinador (opcional)</label>
            <input id="coordInput" type="text" placeholder="alcnca" />
          </div>
        </div>
        <p class="muted" style="margin-top:6px">Si dejas el campo de coordinador vacío, se usará el parámetro de la URL <strong>?coord=</strong> o el valor por defecto <strong>alcnca</strong>.</p>
      </div>

      <div class="section">
        <h4>Alcance de gestión</h4>
        <div class="grid-2">
          <label class="inline"><input type="radio" name="alcance" value="TODOS" checked> Todos los créditos</label>
          <label class="inline"><input type="radio" name="alcance" value="SINGESTION"> Solo sin gestión</label>
        </div>
        <div id="blockUmbral" class="grid-2 hide" style="margin-top: 10px;">
          <div class="field">
            <label for="diasMin">Días sin gestión mínimo</label>
            <input id="diasMin" type="number" min="1" step="1" value="1" />
          </div>
          <div class="field" style="display:flex;align-items:flex-end;">
            <span class="muted">Se incluirán registros sin dato o con <em>Días sin gestión</em> ≥ al valor indicado.</span>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="actions">
        <button id="btnCancelar" class="btn" type="button">Cancelar</button>
        <button id="btnContinuar" class="btn primary" type="button">Continuar</button>
      </div>
    </div>
  </div>
</div>

<!-- Panel de filtros (sin “Tipo” visible) -->
<div id="panelFiltros" class="filtros" aria-live="polite">
  <label>Sucursal:
    <select id="filtroSucursal"><option value="TODAS">Todas</option></select>
  </label>

  <label>Ejecutivo:
    <select id="filtroEjecutivo"><option value="TODOS">Todos</option></select>
  </label>

  <label>Banda:
    <select id="filtroBanda"><option value="TODAS">Todas</option></select>
  </label>

  <span id="contador" class="badge">0 créditos</span>
  <div id="ultima-actualizacion"></div>
</div>

<!-- Botones flotantes en esquina inferior derecha (junto al zoom) -->
<div class="floating-right">
  <div class="home-btn" title="Inicio" onclick="window.location.href='index.html'">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" aria-hidden="true">
      <path d="M280.4 148.3L96 300.1V464c0 8.8 7.2 16 16 16l112-.3c8.8 0 16-7.2 16-16V368c0-8.8 7.2-16 16-16h64c8.8 0 16 7.2 16 16v95.7c0 8.8 7.2 16 16 16l112 .3c8.8 0 16-7.2 16-16V300L295.6 148.3c-5.6-4.7-13.7-4.7-19.2 0zM571.6 251.5L488 182.6V44c0-6.6-5.4-12-12-12h-52c-6.6 0-12 5.4-12 12v72.6L318.5 43c-27.2-22.6-68.2-22.6-95.4 0L4.4 251.5c-5.1 4.2-5.8 11.8-1.6 16.9l21.4 25.6c4.2 5.1 11.8 5.8 16.9 1.6L64 261.2V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V261.2l23.8 20.3c5.1 4.2 12.7 3.5 16.9-1.6l21.4-25.6c4.2-5.1 3.5-12.7-1.5-16.8z"/>
    </svg>
  </div>
</div>

<div id="map" role="application" aria-label="Mapa de créditos"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  /* ---------------- UTILIDADES ---------------- */
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  function parseIntSafe(v, d=0){
    const n = parseInt(v, 10);
    return isNaN(n) ? d : n;
  }

  /* ---------------- ESTADO ---------------- */
  let mapa, capaMarkers = [];
  let dataFiltradaBase = [];
  let lastBounds = null;
  let tipoCarteraGlobal = 'ADMIN';

  /* ---------------- UI Refs ---------------- */
  const overlay = document.getElementById('overlay');
  const selCartera = document.getElementById('selCartera');
  const coordInput = document.getElementById('coordInput');
  const panelFiltros = document.getElementById('panelFiltros');
  const blockUmbral = document.getElementById('blockUmbral');
  const diasMinInput = document.getElementById('diasMin');
  const btnContinuar = document.getElementById('btnContinuar');
  const btnCancelar = document.getElementById('btnCancelar');

  const selSuc  = document.getElementById('filtroSucursal');
  const selEje  = document.getElementById('filtroEjecutivo');
  const selBan  = document.getElementById('filtroBanda');
  const badge   = document.getElementById('contador');
  const lblUlt  = document.getElementById('ultima-actualizacion');

  /* ---------------- Listeners popup ---------------- */
  document.querySelectorAll('input[name="alcance"]').forEach(r => {
    r.addEventListener('change', () => {
      const val = document.querySelector('input[name="alcance"]:checked').value;
      blockUmbral.classList.toggle('hide', val !== 'SINGESTION');
    });
  });
  btnCancelar.addEventListener('click', () => { window.location.href = 'index.html'; });
  btnContinuar.addEventListener('click', () => { iniciar(); });

  /* ---------------- Mapa ---------------- */
  function crearMapa(){
    if (mapa) return mapa;
    // Control de zoom abajo a la derecha
    mapa = L.map('map', { zoomControl: false }).setView([17.05, -96.72], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(mapa);
    L.control.zoom({ position: 'bottomright' }).addTo(mapa);
    return mapa;
  }

  function getIcon(aceptacion, diasAtraso) {
    const n = parseIntSafe(diasAtraso);
    if (n === 88 || n === 89) {
      return L.divIcon({
        className: 'neon-marker',
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
      });
    }
    const url = (String(aceptacion).trim().toUpperCase() === 'SI')
      ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png'
      : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
    return L.icon({
      iconUrl: url,
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
  }

  function limpiarMarkers(){
    capaMarkers.forEach(mk => mapa.removeLayer(mk));
    capaMarkers = [];
  }

  function pasaFiltroCartera(dv, tipo) {
    const atras = parseIntSafe(dv);
    if (tipo === 'ADMIN') return (atras >= 7 && atras < 45);
    if (tipo === 'EXTRA') return (atras >= 45);
    return true;
  }

  function pasaFiltroSinGestion(r, minDias) {
    const v = r['Dias sin Gestion'];
    if (v === null || v === undefined || String(v).trim() === '') return true;
    return parseIntSafe(v) >= minDias;
  }

  function llenarSelectoresBase(arr) {
    selSuc.innerHTML = '<option value="TODAS">Todas</option>';
    const sucursales = [...new Set(arr.map(r => r.Sucursal))].filter(Boolean).sort();
    sucursales.forEach(s => selSuc.append(new Option(s, s)));

    selBan.innerHTML = '<option value="TODAS">Todas</option>';
    const bandas = [...new Set(arr.map(r => r.Banda))].filter(Boolean).sort();
    bandas.forEach(b => selBan.append(new Option(b, b)));

    actualizarEjecutivos(arr, 'TODAS');
  }

  function actualizarEjecutivos(arr, sucSel){
    selEje.innerHTML = '<option value="TODOS">Todos</option>';
    const fuente = sucSel === 'TODAS' ? arr : arr.filter(r => r.Sucursal === sucSel);
    const execs = [...new Set(fuente.map(r => r.Ejecutivo))].filter(Boolean).sort();
    execs.forEach(e => selEje.append(new Option(e, e)));
  }

  function pintarMapaConFiltros() {
    limpiarMarkers();

    const fs = selSuc.value;
    const fe = selEje.value;
    const fb = selBan.value;

    let count = 0;
    dataFiltradaBase.forEach(r => {
      if ((fs !== 'TODAS' && r.Sucursal !== fs) ||
          (fe !== 'TODOS' && r.Ejecutivo !== fe) ||
          (fb !== 'TODAS' && r.Banda !== fb)) return;

      if (!pasaFiltroCartera(r['Dias de Atraso'], tipoCarteraGlobal)) return;

      const lat = parseFloat(r.Latitud), lng = parseFloat(r.Longitud);
      if (!lat || !lng) return;

      const mk = L.marker([lat, lng], { icon: getIcon(r.Aceptacion, r['Dias de Atraso']) }).addTo(mapa);
      mk.bindPopup(
        `<strong>${r.Sucursal}</strong><br>
        Aceptación: ${r.Aceptacion}<br>
        Días sin gestión: ${r['Dias sin Gestion']}<br>
        Línea: ${r.Linea}<br>
        Nombre: ${r.Nombre}<br>
        Saldo: $${r['Saldo Total']}<br>
        % Pagado: ${r['Porcentaje Pagado']}%<br>
        Producto: ${r.Producto}<br>
        Días de atraso: ${r['Dias de Atraso']}<br>
        Ejecutivo: ${r.Ejecutivo}<br>
        Banda: ${r.Banda}`
      );
      mk.bindTooltip(r.Sucursal, {
        permanent: true,
        direction: 'top',
        offset: [0, -10],
        className: 'sucursal-label'
      });
      capaMarkers.push(mk);
      count++;
    });

    badge.textContent = `${count} crédito${count===1?'':'s'}`;

    if (capaMarkers.length > 0) {
      const group = L.featureGroup(capaMarkers);
      lastBounds = group.getBounds().pad(0.2);
      mapa.fitBounds(lastBounds);
    } else if (lastBounds) {
      mapa.fitBounds(lastBounds);
    }
  }

  /* ---------------- Eventos de filtros ---------------- */
  selSuc.addEventListener('change', () => {
    actualizarEjecutivos(dataFiltradaBase, selSuc.value);
    pintarMapaConFiltros();
  });
  selEje.addEventListener('change', pintarMapaConFiltros);
  selBan.addEventListener('change', pintarMapaConFiltros);

  /* ---------------- Flujo inicial ---------------- */
  async function iniciar(){
    tipoCarteraGlobal = document.getElementById('selCartera').value;
    const alcance = document.querySelector('input[name="alcance"]:checked').value;
    const umbral = parseIntSafe(diasMinInput.value, 1);

    const coordURL = getParam('coord');
    const coordinadorClave = (coordInput.value || coordURL || 'alcnca').toLowerCase();

    overlay.style.display = 'none';
    panelFiltros.style.display = 'flex';

    crearMapa();

    const dataUrl = 'datos.json';
    const res = await fetch(dataUrl);
    const lastModified = res.headers.get("Last-Modified");
    if (lastModified) {
      const fecha = new Date(lastModified);
      const fechaFormateada = fecha.toLocaleDateString("es-MX", { day: "numeric", month: "long", year: "numeric" });
      lblUlt.innerText = "Última actualización: " + fechaFormateada;
    }
    const allData = await res.json();

    let base = allData.filter(r => (r.Coordinador || '').toLowerCase() === coordinadorClave);
    base = base.filter(r => pasaFiltroCartera(r['Dias de Atraso'], tipoCarteraGlobal));
    if (alcance === 'SINGESTION') base = base.filter(r => pasaFiltroSinGestion(r, umbral));

    dataFiltradaBase = base;
    llenarSelectoresBase(dataFiltradaBase);
    pintarMapaConFiltros();
  }

  // Autocompletar coordinador desde URL si existe
  const coordURLInit = getParam('coord');
  if (coordURLInit) coordInput.value = coordURLInit;
</script>
</body>
</html>

