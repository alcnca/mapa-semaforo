<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Exhortos / Actas + Agenda (GAS backend)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    .table.table-sm th, .table.table-sm td { font-size: 10px; line-height: 1.10; }
    #tablaPreview td:nth-child(1), #tablaPreview td:nth-child(2) { text-align: center; }
    #tablaPreview td:nth-child(3), #tablaPreview td:nth-child(4) { text-align: left; }
    #tablaPreview td:nth-child(5) { text-align: right; }
    #tablaPreview td:nth-child(6), #tablaPreview td:nth-child(7), #tablaPreview td:nth-child(8) { text-align: center; }
    .tdSaldo { text-align: right; }
    .tdCenter { text-align: center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 10px; }
    /* Si quieres que los modales sean más amplios */
    .modal-xxl { max-width: 95vw; }
  </style>
</head>
<body class="container py-4">
  <h1 class="mb-3">Seguimiento SemiAutomático</h1>

  <!-- Filtros principales -->
  <div class="mb-4 row g-3">
    <div class="col-md-3">
      <label class="form-label">Cartera a revisar:</label>
      <select id="carteraSelect" class="form-select">
        <option value="">-- Selecciona --</option>
        <option value="TODAS">Todas</option>
        <option value="ADMIN">Cartera Administrativa (Fase: Administrativa)</option>
        <option value="EXTRA">Cartera Extrajudicial (Fase: Extrajudicial)</option>
      </select>
    </div>
    <div class="col-md-3" id="mostrarDiv" style="display:none;">
      <label class="form-label">¿Qué mostrar?</label>
      <select id="mostrarSelect" class="form-select">
        <option value="SIN">Solo créditos sin gestión</option>
        <option value="TODOS">Todos</option>
        <option value="PAGOS_UNICOS">Pagos únicos</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Coordinador que firma:</label>
      <select id="coordinadorSelect" class="form-select"></select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Sucursal:</label>
      <select id="sucursalSelect" class="form-select"></select>
    </div>
    <div class="col-md-3" id="subFirmanteDiv" style="display: none">
      <label class="form-label">Firmante (Oficina Central):</label>
      <select id="subFirmanteSelect" class="form-select"></select>
    </div>
    <div class="col-md-3" id="diasMinimosDiv" style="display:none;">
      <label class="form-label">Días mínimos sin gestión:</label>
      <input type="number" id="diasMinimos" value="30" class="form-control" />
      <div class="form-text">Aplica sólo si elegiste “Todos”.</div>
    </div>
  </div>

  <div class="mb-3 d-grid">
    <button class="btn btn-primary" id="btnAplicar">Aplicar</button>
  </div>

  <!-- Botón global para revisar/gestionar la agenda -->
  <div class="mb-3">
    <button class="btn btn-outline-dark w-100" id="btnAbrirAgenda">Revisar Agenda Guardada</button>
  </div>

  <div id="contenido"></div>

  <!-- Modal de Vista Previa -->
  <div class="modal fade" id="vistaPreviaModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Vista Previa del Documento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 id="asesorTitulo"></h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-dark text-center">
                <tr>
                  <th>Crédito</th>
                  <th>Producto</th>
                  <th>Socio</th>
                  <th>Nombre del Socio</th>
                  <th>Saldo</th>
                  <th>Días atraso</th>
                  <th>Días sin gestión</th>
                  <th>Fase</th>
                </tr>
              </thead>
              <tbody id="tablaPreview"></tbody>
            </table>
          </div>
          <h6 class="mt-3 text-center" id="totalPreview"></h6>
        </div>
        <div class="modal-footer gap-2">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button class="btn btn-success" id="btnGenerarExhorto">Generar Exhorto</button>
          <button class="btn btn-outline-success" id="btnGenerarActa">Generar Acta Administrativa</button>
          <button class="btn btn-outline-primary" id="btnAgendaPreview">Crear agenda de estos socios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Crear agenda (guardado vía GAS) -->
  <div class="modal fade" id="agendaModal" tabindex="-1">
    <div class="modal-dialog modal-xxl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Agenda de seguimiento — <span id="agendaTitulo"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="alert alert-info mb-3">
            Completa la <strong>Fecha programada</strong> y <strong>Observaciones</strong> por socio. <br>
            La <strong>Fecha de registro</strong> se llena automáticamente. <br>
            Al guardar, se envía a <strong>Google Apps Script</strong> (que lo sube a GitHub).
          </div>

          <!-- Quién realiza (automático) -->
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">Quién realiza la agenda (automático) <span class="text-danger">*</span></label>
              <input id="agendaRealizaRO" class="form-control" readonly />
              <div class="form-text">Se toma del Coordinador seleccionado o del Firmante de Oficina Central.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Fecha de registro (automática)</label>
              <input id="agendaFechaRegistroRO" class="form-control mono" readonly />
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-dark text-center">
                <tr>
                  <th>#</th>
                  <th>Crédito</th>
                  <th>Socio</th>
                  <th>Nombre</th>
                  <th>Sucursal</th>
                  <th>Asesor</th>
                  <th>Producto</th>
                  <th>Saldo</th>
                  <th>Días atraso</th>
                  <th>Días sin gestión</th>
                  <th>Fase</th>
                  <th>Fecha programada</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody id="agendaTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer gap-2">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnGuardarAgenda">Guardar agenda (GAS)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Visualizar compromisos (consulta vía GAS, sin “Archivo”) -->
  <div class="modal fade" id="agendaListaModal" tabindex="-1">
    <div class="modal-dialog modal-xxl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Agenda guardada</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-2 mb-3">
            <div class="col-md-3">
              <button class="btn btn-outline-primary w-100" id="btnCargarHoy">Cargar agendas de HOY</button>
            </div>
            <div class="col-md-3">
              <input id="filtroTextoAgenda" class="form-control" placeholder="Buscar (socio, nombre, asesor, sucursal)">
            </div>
            <div class="col-md-3">
              <input id="filtroFechaAgenda" class="form-control" type="date" />
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-dark text-center">
                <tr>
                  <th>#</th>
                  <th>Fecha registro</th>
                  <th>Fecha prog.</th>
                  <th>Crédito</th>
                  <th>Socio</th>
                  <th>Nombre</th>
                  <th>Sucursal</th>
                  <th>Asesor</th>
                  <th>Producto</th>
                  <th>Saldo</th>
                  <th>Días atraso</th>
                  <th>Días sin gestión</th>
                  <th>Fase</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody id="agendaListaTbody"></tbody>
            </table>
          </div>
          <div class="small text-muted">
            *Si tu backend GAS aún no implementa el listado (doGet), el sistema usa un respaldo local (localStorage).
          </div>
        </div>

        <div class="modal-footer gap-2">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===================== CONFIG (Backend GAS) ===================== */
    const GAS_URL="https://script.google.com/macros/s/AKfycbxaMeSTUuijaEirJOITVxVVPOTX7rx_ZH4dwnGdGXWM_wmcnlUO6iYOjPng7WiT12Io/exec"; // p. ej. https://script.google.com/macros/s/AKfycb.../exec

    /* ===================== Origen de datos ===================== */
    const URL_DATOS = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/refs/heads/main/datos.json";
    const URL_DIRECCION = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/refs/heads/main/Direccion.json";
    const HEADER_URL = "https://alcnca.github.io/mapa-semaforo/encabezado.png";
    const FOOTER_URL = "https://alcnca.github.io/mapa-semaforo/piepagina.png";

    let HEADER_DATA = null, FOOTER_DATA = null;
    let data = [], direcciones = [];
    let creditosSeleccionados = [];
    let asesorSeleccionado = "", sucursalSeleccionada = "";
    let carteraSeleccionada = "", mostrarModo = "SIN";
    let cacheAgendas = [];

    /* ===================== Catálogos ===================== */
    const nombresCoordinadores = {
      DASADI: "DANIEL SANCHEZ DIAZ",
      FAPERO: "FRANCISCO ANTONIO PEREZ RODRIGUEZ",
      ALCNCA: "ALONSO CANCHE CASTILLO",
      MCRAVI: "MARLEN CECILIA RAMIREZ VILLANUEVA",
      INANME: "INES ANDRADE MENDEZ",
      MISADA: "MARIO ISRAEL SALINAS DAMIAN",
      OFICINA_CENTRAL: "OFICINA CENTRAL"
    };
    const oficinaCentral = [
      { nombre: "ROBERTO JAVIER PÉREZ SANTIAGO", puesto: "COORDINADOR DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "SANDRA LORENA PACHECO ROBLES", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "ROLANDO VALERIANO HURTADO", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "ANDREA ACELA MORGA DÁVILA", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "GUSTAVO ESTUDILLO DE LA CRUZ", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "ALFONSO JERÓNIMO HERNÁNDEZ", puesto: "COORDINADOR DE RECUPERACIÓN PREVENTIVA Y ADMINISTRATIVA" },
      { nombre: "ZOIBETH YANELI SORIANO IBAÑEZ", puesto: "ASISTENTE DE RECUPERACIÓN PREVENTIVA Y ADMINISTRATIVA" },
      { nombre: "ABEL EDUARDO JIMENEZ GASPAR", puesto: "ASISTENTE DE RECUPERACIÓN PREVENTIVA Y ADMINISTRATIVA" }
    ];

    /* ===================== Utils ===================== */
    async function blobToDataURL(blob){ return await new Promise(res => { const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }
    async function fetchAsDataURL(url){ try{ const r=await fetch(url,{cache:"force-cache"}); if(!r.ok) throw 0; const b=await r.blob(); return await blobToDataURL(b); } catch{ return null; } }
    const norm = (s) => (s ?? "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " ").trim().toUpperCase();
    function toNumberSafe(val){ if (val == null) return 0; if (typeof val === "number") return isFinite(val) ? val : 0; const n = parseFloat(String(val).replace(/[^0-9.-]/g, "")); return isNaN(n) ? 0 : n; }
    function parseDiasSinGestion(raw){
      if (raw == null) return null;
      const s = String(raw).toLowerCase().trim();
      const marcadores = new Set(["","sin gestion","sin gestión","s/g","sg","sen gestion","sin-gestion","sin_gestion"]);
      if (marcadores.has(s)) return null;
      const soloNum = s.replace(/[^0-9-]/g,"");
      if (!soloNum || soloNum === "-" || soloNum === "--") return null;
      const n = parseInt(soloNum,10);
      return isNaN(n) ? null : n;
    }
    const estaSinGestion = (raw) => parseDiasSinGestion(raw) === null;
    const valProducto = (r) => r.producto ?? r.Producto ?? r.product ?? r.Product ?? "";
    const valSocio    = (r) => r.socio ?? r.Socio ?? r["Num Socio"] ?? r["Numero Socio"] ?? r["Número de Socio"] ?? "";
    const valFase     = (r) => r.fase ?? r.Fase ?? r.FASE ?? r["Fase del crédito"] ?? r["Fase del credito"] ?? "";
    const valDiasAtr  = (r) => r["Dias de Atraso"] ?? r["Días de atraso"] ?? r["Dias atraso"] ?? r["Días atraso"] ?? "";
    const valSaldo    = (r) => toNumberSafe(r["Saldo Total"]);
    function parseCuotas(raw){ if(raw==null) return NaN; const s=String(raw).trim().toLowerCase(); const m=s.match(/^\s*(\d+)\s*(?:\/|\s*de\s*)?\s*(\d+)?\s*$/i); if(m) return parseInt(m[1],10); const n=parseInt(s.replace(/[^\d-]/g,""),10); return isNaN(n)?NaN:n; }
    function cumplePagosUnicos(r){
      const coord=(r.Coordinacion ?? r.coordinacion ?? r["Coordinación"] ?? r["COORDINACION"] ?? r["COORDINACIÓN"] ?? "").toString();
      const coordNorm=norm(coord);
      const cuotas=parseCuotas(r.Cuotas ?? r.cuotas ?? r["Cuotas"] ?? r["CUOTAS"] ?? r["Numero de Cuotas"] ?? r["Número de Cuotas"] ?? r["Num Cuotas"] ?? r["NumCuotas"] ?? r["Cuota"] ?? r["Pagos"]);
      return coordNorm==="AGRONEGOCIOS" && cuotas===1;
    }
    const FASES_MAP={ ADMIN:["ADMINISTRATIVA"], EXTRA:["EXTRAJUDICIAL"] };
    function faseEnGrupo(rec,grupo){ const f=norm(valFase(rec)); if(!f) return false; const lista=FASES_MAP[grupo]||[]; return lista.some(alias=> f.includes(norm(alias))); }

    /* ===================== Textos (PDF resumido) ===================== */
    const meses=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
    function numEnEsp(n){ const u=["cero","uno","dos","tres","cuatro","cinco","seis","siete","ocho","nueve","diez","once","doce","trece","catorce","quince","dieciséis","diecisiete","dieciocho","diecinueve","veinte","veintiuno","veintidós","veintitrés","veinticuatro","veinticinco","veintiséis","veintisiete","veintiocho","veintinueve"]; if(n<30)return u[n]; const d=["","","","treinta","cuarenta","cincuenta"]; const dec=Math.floor(n/10),uni=n%10; return uni===0? d[dec]:`${d[dec]} y ${u[uni]}`; }
    function anioEnLetras(y){ const map={2023:"dos mil veintitrés",2024:"dos mil veinticuatro",2025:"dos mil veinticinco",2026:"dos mil veintiséis"}; return map[y]||y.toString(); }
    function ahoraCDMX(){ const ahora=new Date(); return new Date(ahora.toLocaleString("en-US",{timeZone:"America/Mexico_City"})); }
    function fechaEnLetrasFrom(dateObj){ const h=dateObj.getHours(), m=dateObj.getMinutes(), d=dateObj.getDate(), mm=dateObj.getMonth(), y=dateObj.getFullYear(); return `${numEnEsp(h)} horas con ${m===0?"cero":numEnEsp(m)} minutos del ${numEnEsp(d)} de ${meses[mm]} de ${anioEnLetras(y)}`; }
    function getDireccionPorSucursal(sucursal){
      const sNorm=norm(sucursal);
      let found=direcciones.find(d=>norm(d.Nombre_Sucursal)===sNorm);
      if(found) return found;
      found = direcciones.find(d => norm(d.SUCURSAL)===sNorm || norm(d.Sucursal)===sNorm || norm(d.Nombre)===sNorm);
      if(found) return found;
      found = direcciones.find(d => norm(d.Nombre_Sucursal||"").includes(sNorm));
      return found||null;
    }
    function getTextosDocumento(tipo, diasMinimos, asesor, sucursal, firmanteCoord){
      if(tipo==="acta"){
        const dir=getDireccionPorSucursal(sucursal)||{};
        const inicioLocal=ahoraCDMX(), cierreLocal=new Date(inicioLocal.getTime()+30*60000);
        const intro=`En la sucursal de ${dir.Nombre_Sucursal||sucursal}, siendo las ${fechaEnLetrasFrom(inicioLocal)}...`;
        const hechos=`Hechos:\nSe hace constar que el C. ${asesor} ...`;
        const faltas=`Faltas y omisiones detectadas:\n1.4 ...\n1.5 ...\n2. ...\n3.14 ...`;
        const determinacion=`Determinación:\nPor lo anterior, ...`;
        const cierre=`Leída que fue la presente... Siendo las ${fechaEnLetrasFrom(cierreLocal)} ...`;
        return { titulo:"ACTA ADMINISTRATIVA", subtitulo:"Se levanta la presente ACTA ADMINISTRATIVA", intro, hechos, faltas, determinacion, cierre, gerenteSucursal: (dir.GERENTE||"_________________") };
      }
      const subtitulo=`Motivo: Tener créditos en su cartera con más de ${diasMinimos} días sin gestión`;
      const intro=`Me permito informarle que, derivado de la revisión ...`;
      const postTabla=`Derivado de esta situación se detecta su falta ...`;
      return { titulo:"EXHORTO", subtitulo, intro, postTabla };
    }

    /* ===================== Inicio ===================== */
    window.addEventListener("DOMContentLoaded", async () => {
      try{
        const [resDatos, resDir, headerData, footerData] = await Promise.all([
          fetch(URL_DATOS,{cache:"no-store"}), fetch(URL_DIRECCION,{cache:"no-store"}),
          fetchAsDataURL(HEADER_URL), fetchAsDataURL(FOOTER_URL)
        ]);
        data = await resDatos.json();
        const dirJson = await resDir.json();
        if(Array.isArray(dirJson)) direcciones=dirJson; else if (dirJson && typeof dirJson==="object"){ const vals=Object.values(dirJson); direcciones=(vals.length && typeof vals[0]==="object")? vals : [dirJson]; } else direcciones=[];
        HEADER_DATA=headerData; FOOTER_DATA=footerData;
      }catch(e){ alert("Error cargando datos: "+e.message); return; }

      const selCoord=document.getElementById("coordinadorSelect");
      selCoord.innerHTML='<option value="">-- Selecciona --</option>';
      for(const k in nombresCoordinadores){ selCoord.innerHTML+=`<option value="${k}">${nombresCoordinadores[k]}</option>`; }

      document.getElementById("carteraSelect").addEventListener("change", () => {
        carteraSeleccionada = document.getElementById("carteraSelect").value;
        document.getElementById("mostrarDiv").style.display = carteraSeleccionada ? "block" : "none";
        actualizarSucursales();
      });
      document.getElementById("mostrarSelect").addEventListener("change", () => {
        mostrarModo = document.getElementById("mostrarSelect").value;
        document.getElementById("diasMinimosDiv").style.display = (mostrarModo==="TODOS") ? "block" : "none";
        actualizarSucursales();
      });

      selCoord.addEventListener("change", () => {
        const subDiv=document.getElementById("subFirmanteDiv");
        const subSel=document.getElementById("subFirmanteSelect");
        subSel.innerHTML="";
        const valorCoord=selCoord.value;
        if(valorCoord==="OFICINA_CENTRAL"){
          oficinaCentral.forEach(p=> subSel.innerHTML+=`<option value="${p.nombre}">${p.nombre} (${p.puesto})</option>`);
          subDiv.style.display="block";
        } else if (valorCoord){
          subDiv.style.display="none";
          if(valorCoord==="ALCNCA"){
            subDiv.style.display="block";
            subSel.innerHTML+=`<option value="ALCNCA">${nombresCoordinadores["ALCNCA"]} (Coordinador)</option>`;
            subSel.innerHTML+=`<option value="IVANI">IVANI ARCOS LAINES (Gestor Regional Zona Maya)</option>`;
          }
        }
        actualizarSucursales();
      });

      document.getElementById("btnAplicar").addEventListener("click", cargarDatos);

      document.getElementById("btnAbrirAgenda").addEventListener("click", () => {
        const today = new Date().toISOString().slice(0,10);
        document.getElementById("filtroFechaAgenda").value = today;
        document.getElementById("agendaListaTbody").innerHTML = `<tr><td colspan="14" class="text-center text-muted">Clic en "Cargar agendas de HOY".</td></tr>`;
        new bootstrap.Modal(document.getElementById("agendaListaModal")).show();
      });

      document.getElementById("btnCargarHoy").addEventListener("click", cargarAgendasDesdeServidor);
      document.getElementById("filtroTextoAgenda").addEventListener("input", aplicarFiltrosTablaAgenda);
      document.getElementById("filtroFechaAgenda").addEventListener("change", aplicarFiltrosTablaAgenda);
    });

    /* ===================== Render principal ===================== */
    function llenarSucursales(lista){
      const selSuc=document.getElementById("sucursalSelect");
      const actual=selSuc.value;
      selSuc.innerHTML='<option value="TODAS">Todas</option>';
      lista.forEach(s=> selSuc.innerHTML+=`<option value="${s}">${s}</option>`);
      if(lista.includes(actual)) selSuc.value=actual; else selSuc.value="TODAS";
    }
    function creditosBaseFiltradosPorCartera(){
      return data.filter(d=>{
        if(carteraSeleccionada==="ADMIN") return faseEnGrupo(d,"ADMIN");
        if(carteraSeleccionada==="EXTRA") return faseEnGrupo(d,"EXTRA");
        if(carteraSeleccionada==="TODAS") return true;
        return false;
      });
    }
    function actualizarSucursales(){
      const coordSel=document.getElementById("coordinadorSelect").value;
      let base=data.slice();
      if(carteraSeleccionada){ base=creditosBaseFiltradosPorCartera(); } else { llenarSucursales([]); return; }
      if(coordSel && coordSel!=="OFICINA_CENTRAL"){ const target=norm(coordSel); base=base.filter(d=> norm(d.Coordinador)===target ); }
      if(mostrarModo==="SIN"){ base=base.filter(d=> estaSinGestion(d["Dias sin Gestion"])); }
      else if(mostrarModo==="PAGOS_UNICOS"){ base=base.filter(cumplePagosUnicos); }
      const sucursales=[...new Set(base.map(d=>d.Sucursal))].filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
      llenarSucursales(sucursales);
    }
    function renderTarjetasPorSucursal(base, sucursal){
      const porAsesor={};
      base.filter(r=> r.Sucursal===sucursal).forEach(r=>{
        const ejecutivo = r.Ejecutivo || "SIN ASESOR";
        (porAsesor[ejecutivo] ||= []).push(r);
      });
      const cont=document.getElementById("contenido");
      const h4=document.createElement("h4"); h4.className="mt-3 mb-3"; h4.textContent=`Sucursal: ${sucursal}`; cont.appendChild(h4);

      const nombresAsesores=Object.keys(porAsesor).sort((a,b)=>a.localeCompare(b,"es"));
      if(nombresAsesores.length===0){ const alert=document.createElement("div"); alert.className="alert alert-info"; alert.textContent="Sin registros con los criterios seleccionados en esta sucursal."; cont.appendChild(alert); return; }

      for(const asesor of nombresAsesores){
        const lista=porAsesor[asesor];
        const total=lista.reduce((acc,r)=> acc + toNumberSafe(r["Saldo Total"]), 0);
        const card=document.createElement("div"); card.className="card mb-3";
        card.innerHTML=`
          <div class="card-header bg-primary text-white">${asesor}</div>
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              Créditos: ${lista.length}<br />
              Total: $${total.toLocaleString("es-MX",{minimumFractionDigits:2})}
            </div>
            <button class="btn btn-warning btn-sm">Vista Previa</button>
          </div>`;
        card.querySelector("button").onclick=()=>{ sucursalSeleccionada=sucursal; mostrarVistaPrevia(asesor, lista); };
        cont.appendChild(card);
      }
    }
    async function cargarDatos(){
      if(!carteraSeleccionada){ alert("Selecciona primero la Cartera a revisar."); return; }
      const sucSel=(document.getElementById("sucursalSelect").value)||"TODAS";
      const diasFiltro=parseInt(document.getElementById("diasMinimos").value)||30;

      let base=creditosBaseFiltradosPorCartera();
      const coordSel=document.getElementById("coordinadorSelect").value;
      if(coordSel && coordSel!=="OFICINA_CENTRAL"){ const target=norm(coordSel); base=base.filter(d=> norm(d.Coordinador)===target ); }
      if(mostrarModo==="SIN"){ base=base.filter(d=> estaSinGestion(d["Dias sin Gestion"])); }
      else if(mostrarModo==="PAGOS_UNICOS"){ base=base.filter(cumplePagosUnicos); }
      else{ base=base.filter(d=>{ const dias=parseDiasSinGestion(d["Dias sin Gestion"]); return (dias===null) || (typeof dias==="number" && dias>=diasFiltro); }); }

      const cont=document.getElementById("contenido"); cont.innerHTML="";
      if(sucSel!=="TODAS"){ renderTarjetasPorSucursal(base, sucSel); }
      else{
        const sucursales=[...new Set(base.map(d=>d.Sucursal))].filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
        if(sucursales.length===0){ cont.innerHTML=`<div class="alert alert-info">No se encontraron créditos con los criterios seleccionados.</div>`; return; }
        for(const s of sucursales){ renderTarjetasPorSucursal(base, s); }
      }
    }

    /* ===================== Vista previa + AGENDA (GAS) ===================== */
    function getResponsableActual(){
      const coordVal = document.getElementById("coordinadorSelect").value;
      if (!coordVal) return "";
      if (coordVal === "OFICINA_CENTRAL") {
        const sub = document.getElementById("subFirmanteSelect").value || "";
        return sub.trim();
      }
      return (nombresCoordinadores[coordVal] || "").trim();
    }

    function mostrarVistaPrevia(asesor, creditos){
      asesorSeleccionado=asesor; creditosSeleccionados=creditos;
      const telEjecutivo = (creditos.find(c=>c["Telefono Ejecutivo"])?.["Telefono Ejecutivo"]) ?? (creditos.find(c=>c.Telefono_Ejecutivo)?.Telefono_Ejecutivo) ?? (creditos.find(c=>c.TelefonoEjecutivo)?.TelefonoEjecutivo) ?? "";
      document.getElementById("asesorTitulo").textContent = `Asesor: ${asesor} | Tel: ${telEjecutivo || "s/n"} | Sucursal: ${sucursalSeleccionada}`;

      const tbody=document.getElementById("tablaPreview"); tbody.innerHTML="";
      let total=0;
      creditos.forEach(c=>{
        const saldo=valSaldo(c); total+=saldo;
        const dsgParsed=parseDiasSinGestion(c["Dias sin Gestion"]); const dsgDisplay=(dsgParsed===null)?"SIN GESTIÓN":dsgParsed;
        tbody.innerHTML += `
          <tr>
            <td>${c.Linea ?? ""}</td>
            <td>${valProducto(c)}</td>
            <td>${valSocio(c)}</td>
            <td>${c.Nombre ?? ""}</td>
            <td class="text-end">${saldo.toLocaleString("es-MX",{style:"currency",currency:"MXN"})}</td>
            <td class="text-center">${valDiasAtr(c)}</td>
            <td class="text-center">${dsgDisplay}</td>
            <td class="text-center">${valFase(c)}</td>
          </tr>`;
      });
      document.getElementById("totalPreview").textContent = `TOTAL: ${total.toLocaleString("es-MX",{style:"currency",currency:"MXN"})}`;

      const btnExhorto=document.getElementById("btnGenerarExhorto");
      const btnActa=document.getElementById("btnGenerarActa");
      btnExhorto.onclick=async()=>{ btnExhorto.disabled=true; try{ await generarPDF(asesorSeleccionado, sucursalSeleccionada, creditosSeleccionados, "exhorto"); } finally{ btnExhorto.disabled=false; } };
      btnActa.onclick=async()=>{ btnActa.disabled=true; try{ await generarPDF(asesorSeleccionado, sucursalSeleccionada, creditosSeleccionados, "acta"); } finally{ btnActa.disabled=false; } };

      document.getElementById("btnAgendaPreview").onclick = () => {
        const responsable = getResponsableActual();
        if (!responsable) {
          alert("Selecciona primero el 'Coordinador que firma' (o un firmante de Oficina Central).");
          return;
        }
        document.getElementById("agendaTitulo").textContent = `${sucursalSeleccionada} — ${asesorSeleccionado}`;
        document.getElementById("agendaRealizaRO").value = responsable;

        const isoNow = new Date().toISOString();
        document.getElementById("agendaFechaRegistroRO").value = isoNow;

        buildItemsFromPreview(isoNow);
        new bootstrap.Modal(document.getElementById("agendaModal")).show();
      };

      new bootstrap.Modal(document.getElementById("vistaPreviaModal")).show();
    }

    function buildItemsFromPreview(isoRegistro){
      const hoy = new Date().toISOString().slice(0,10);
      const tbody = document.getElementById("agendaTbody");
      tbody.innerHTML = "";
      if (!Array.isArray(creditosSeleccionados) || creditosSeleccionados.length===0){
        tbody.innerHTML = `<tr><td colspan="13" class="text-center text-muted">No hay filas en la vista previa.</td></tr>`;
        return;
      }
      creditosSeleccionados.forEach((c, idx) => {
        const saldo = valSaldo(c);
        const dsgParsed = parseDiasSinGestion(c["Dias sin Gestion"]);
        const dsgDisplay = (dsgParsed===null) ? "SIN GESTIÓN" : dsgParsed;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="tdCenter">${idx+1}</td>
          <td class="tdCredito mono">${c.Linea ?? ""}</td>
          <td class="tdSocio mono">${valSocio(c)}</td>
          <td class="tdNombre">${c.Nombre ?? ""}</td>
          <td class="tdSucursal">${sucursalSeleccionada || (c.Sucursal ?? "")}</td>
          <td class="tdAsesor">${asesorSeleccionado || (c.Ejecutivo ?? "")}</td>
          <td class="tdProducto">${valProducto(c)}</td>
          <td class="tdSaldo">${saldo.toLocaleString("es-MX",{style:"currency",currency:"MXN"})}</td>
          <td class="tdDiasAtr tdCenter">${valDiasAtr(c)}</td>
          <td class="tdDiasSinGes tdCenter">${dsgDisplay}</td>
          <td class="tdFase tdCenter">${valFase(c)}</td>
          <td><input type="date" class="form-control form-control-sm fecha-prog" value="${hoy}"></td>
          <td><input type="text" class="form-control form-control-sm obs-prog" maxlength="320" placeholder="Observación (máx. 320)"></td>
        `;
        tr.dataset.fechaRegistro = isoRegistro;
        tbody.appendChild(tr);
      });
    }

    /* ===================== PDF ===================== */
    function pageEnv(doc){
      const HEADER={x:50,y:20,w:500,h:80};
      const CONTENT_TOP=HEADER.y+HEADER.h+20, FOOTER_RESERVE=90;
      return {
        CONTENT_TOP, FOOTER_RESERVE,
        marginFor:(left=50,right=50)=>({ top: CONTENT_TOP, left, right, bottom: FOOTER_RESERVE }),
        didDrawPage:()=>{ if(HEADER_DATA){ try{ doc.addImage(HEADER_DATA,"PNG",HEADER.x,HEADER.y,HEADER.w,HEADER.h);}catch{} } },
        ensureSpace:(y,extra=0)=>{ const usableBottom=doc.internal.pageSize.getHeight()-FOOTER_RESERVE; if(y+extra>usableBottom){ doc.addPage(); return CONTENT_TOP; } return y; }
      };
    }
    function addParagraph(doc, text, startY, env, left=50, right=50){
      doc.autoTable({ startY, body:[[text]], theme:"plain", styles:{ fontSize:9, halign:"justify", cellPadding:1.2 }, margin:env.marginFor(left,right), didDrawPage:env.didDrawPage });
      return (doc.lastAutoTable && doc.lastAutoTable.finalY) || startY;
    }
    async function generarPDF(asesor,sucursal,creditos,tipo){
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF("p","pt","a4"); doc.setLineHeightFactor(1.0);
      const env=pageEnv(doc);
      const fecha=new Date().toLocaleDateString("es-MX",{day:"2-digit",month:"long",year:"numeric"});
      const diasMinimos=parseInt(document.getElementById("diasMinimos").value)||30;

      const inicial=document.getElementById("coordinadorSelect").value;
      const subFirmanteVal=document.getElementById("subFirmanteSelect").value || inicial;
      let firmanteCoord;
      if(inicial==="OFICINA_CENTRAL"){ firmanteCoord=subFirmanteVal||"__________________________"; }
      else if(subFirmanteVal && nombresCoordinadores[subFirmanteVal]){ firmanteCoord=nombresCoordinadores[subFirmanteVal]; }
      else { firmanteCoord=nombresCoordinadores[inicial]||"__________________________"; }

      const textos=getTextosDocumento(tipo, diasMinimos, asesor, sucursal, firmanteCoord);

      let y=env.CONTENT_TOP; const pageWidth=doc.internal.pageSize.getWidth();
      doc.setFontSize(10); doc.text(`Fecha: ${fecha}`,50,y); y+=18;
      doc.setFontSize(14); doc.text(textos.titulo,pageWidth/2,y,{align:"center"}); y+=18;
      doc.setFontSize(12); doc.text(textos.subtitulo||"",pageWidth/2,y,{align:"center"}); y+=24;
      doc.setFontSize(11); doc.text(`Para: ${asesor}`,50,y); y+=14; doc.text(`Sucursal: ${sucursal}`,50,y); y+=10;

      y = addParagraph(doc, textos.intro, y, env, 50, 50);
      y = (doc.lastAutoTable?.finalY || y) + 12; y = env.ensureSpace(y, 10);

      const rows=creditos.map(c=>{
        const dsgParsed=parseDiasSinGestion(c["Dias sin Gestion"]);
        const dsgDisplay=(dsgParsed===null)?"SIN GESTIÓN":dsgParsed;
        return [ c.Linea??"", valProducto(c), valSocio(c), c.Nombre??"", toNumberSafe(c["Saldo Total"]).toLocaleString("es-MX",{style:"currency",currency:"MXN"}), valDiasAtr(c), dsgDisplay, valFase(c) ];
      });

      doc.autoTable({
        startY:y,
        head:[["Crédito","Producto","Socio","Nombre del Socio","Saldo","Días atraso","Días sin gestión","Fase"]],
        body:rows,
        styles:{ fontSize:8, cellPadding:1.3, lineWidth:.1, valign:"middle" },
        headStyles:{ fillColor:[0,0,0], textColor:[255,255,255], halign:"center", fontSize:8 },
        columnStyles:{ 0:{halign:"center"},1:{halign:"center"},2:{halign:"left"},3:{halign:"left"},4:{halign:"right"},5:{halign:"center"},6:{halign:"center"},7:{halign:"center"} },
        margin:env.marginFor(40,40),
        didDrawPage:env.didDrawPage
      });
      y=(doc.lastAutoTable?.finalY || y)+8; y=env.ensureSpace(y,10);
      doc.setFontSize(11);
      const totalImporte=creditos.reduce((acc,c)=> acc + toNumberSafe(c["Saldo Total"]), 0);
      doc.text(`TOTAL: ${totalImporte.toLocaleString("es-MX",{style:"currency",currency:"MXN"})}`, pageWidth/2, y, {align:"center"}); y+=12;

      if(tipo==="acta"){
        y=addParagraph(doc,"Hechos: ...",y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+6;
        y=addParagraph(doc,"Faltas y omisiones detectadas: ...",y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+6;
        y=addParagraph(doc,"Determinación: ...",y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+96;
        y=addParagraph(doc,"Cierre ...",y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+18;
      } else {
        const { postTabla } = getTextosDocumento("exhorto", diasMinimos);
        y=addParagraph(doc,postTabla,y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+18;
        y=env.ensureSpace(y,120); doc.setFontSize(11);
        doc.text("Atentamente,", pageWidth/2, y, {align:"center"}); y+=30;
        doc.text("_______________________________", pageWidth/2, y, {align:"center"}); y+=14;
        doc.text("Coordinación de Recuperación", pageWidth/2, y, {align:"center"});
      }
      const pageCount=doc.getNumberOfPages();
      for(let i=1;i<=pageCount;i++){ doc.setPage(i); const pageW=doc.internal.pageSize.getWidth(), pageH=doc.internal.pageSize.getHeight(); const footerWidth=500, footerHeight=50, footerX=(pageW-footerWidth)/2, footerY=pageH-footerHeight-20; if(FOOTER_DATA){ try{ doc.addImage(FOOTER_DATA,"PNG",footerX,footerY,footerWidth,footerHeight);}catch{} } doc.setFontSize(9); doc.text(`Página ${i} de ${pageCount}`, pageW-60, footerY-6, {align:"right"}); }
      const nombreArchivo=(tipo==="acta"?"ACTA_ADMINISTRATIVA":"EXHORTO");
      doc.save(`${nombreArchivo}_${asesor.replace(/ /g,"_")}_${norm(sucursal).replace(/[^A-Z0-9_]/g,"")}.pdf`);
    }

    /* ===================== Guardar en GAS (sube a GitHub en el backend) ===================== */
    async function subirAgendaViaGAS(agendaData) {
      if (!GAS_URL || GAS_URL.includes("PEGAR_AQUI")) throw new Error("Configura GAS_URL con tu Web App de Google Apps Script.");
      // Importante: SIN headers para evitar preflight/OPTIONS
      const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(agendaData) });
      const j = await res.json();
      if (!j.ok) throw new Error(j.error || "Error subiendo agenda");
      return j; // { ok:true, path, file, gh }
    }

    document.getElementById("btnGuardarAgenda").addEventListener("click", async () => {
      const responsable = getResponsableActual();
      if (!responsable) {
        alert("Selecciona primero el 'Coordinador que firma' (o un firmante de Oficina Central).");
        return;
      }
      const filas = document.querySelectorAll("#agendaTbody tr");
      if (!filas.length) { alert("No hay filas para guardar."); return; }

      const items = [];
      filas.forEach(tr => {
        const fechaRegistro = tr.dataset.fechaRegistro || new Date().toISOString();
        const credito = tr.querySelector(".tdCredito")?.innerText.trim() || "";
        const socio   = tr.querySelector(".tdSocio")?.innerText.trim() || "";
        const nombre  = tr.querySelector(".tdNombre")?.innerText.trim() || "";
        const suc     = tr.querySelector(".tdSucursal")?.innerText.trim() || "";
        const asesor  = tr.querySelector(".tdAsesor")?.innerText.trim() || "";
        const producto= tr.querySelector(".tdProducto")?.innerText.trim() || "";
        const saldoTx = tr.querySelector(".tdSaldo")?.innerText.trim() || "";
        const diasAtr = tr.querySelector(".tdDiasAtr")?.innerText.trim() || "";
        const diasSG  = tr.querySelector(".tdDiasSinGes")?.innerText.trim() || "";
        const fase    = tr.querySelector(".tdFase")?.innerText.trim() || "";
        const fechaProg = tr.querySelector(".fecha-prog")?.value || "";
        const obs     = tr.querySelector(".obs-prog")?.value || "";

        items.push({
          fecha_registro: fechaRegistro,
          credito, socio, nombre, sucursal: suc, asesor,
          producto, saldo: saldoTx, dias_atraso: diasAtr, dias_sin_gestion: diasSG, fase,
          fecha_programada: fechaProg,
          observaciones: obs
        });
      });

      const agendaData = {
        generado_en: new Date().toISOString(),
        quien_realiza: responsable,
        sucursal: sucursalSeleccionada || "",
        asesor: asesorSeleccionado || "",
        total: items.length,
        items
      };

      try {
        const r = await subirAgendaViaGAS(agendaData);
        // respaldo local opcional (por si quieres ver sin backend de listados)
        try {
          const local = JSON.parse(localStorage.getItem("agendas_local_backup") || "[]");
          local.push({ saved_at: new Date().toISOString(), path: r.path, data: agendaData });
          localStorage.setItem("agendas_local_backup", JSON.stringify(local));
        } catch {}
        alert("✅ Agenda subida: " + r.path);
        bootstrap.Modal.getInstance(document.getElementById("agendaModal"))?.hide();
      } catch (e) {
        alert("❌ Error al subir:\n" + (e.message || e));
      }
    });

    /* ===================== Listar Agendas (GAS doGet?mode=list&date=YYYY-MM-DD) ===================== */
    async function cargarAgendasDesdeServidor(){
      const tbody = document.getElementById("agendaListaTbody");
      const fecha = (document.getElementById("filtroFechaAgenda").value || new Date().toISOString().slice(0,10));
      tbody.innerHTML = `<tr><td colspan="14" class="text-center text-muted">Cargando...</td></tr>`;
      try{
        if (!GAS_URL || GAS_URL.includes("PEGAR_AQUI")) throw new Error("Configura GAS_URL");
        const url = `${GAS_URL}?mode=list&date=${encodeURIComponent(fecha)}`;
        const res = await fetch(url, { method: "GET" });
        const j = await res.json();
        if (!j.ok) throw new Error(j.error || "Backend no respondió OK");
        cacheAgendas = Array.isArray(j.items) ? j.items : [];
        if (cacheAgendas.length === 0) {
          tbody.innerHTML = `<tr><td colspan="14" class="text-center text-muted">Sin agendas para la fecha.</td></tr>`;
          return;
        }
        renderTablaAgendaDesdeCache();
      } catch (err) {
        // Fallback a localStorage si no hay backend de lista
        try {
          const local = JSON.parse(localStorage.getItem("agendas_local_backup") || "[]");
          const rows = [];
          local.forEach(entry => {
            const arr = entry?.data?.items || [];
            arr.forEach(it => {
              if ((it.fecha_programada || "").slice(0,10) === fecha) {
                rows.push({
                  fecha_reg: it.fecha_registro || entry.saved_at || "",
                  fecha_prog: it.fecha_programada || "",
                  credito: it.credito||"", socio: it.socio||"", nombre: it.nombre||"",
                  sucursal: it.sucursal||"", asesor: it.asesor||"",
                  producto: it.producto||"", saldo: it.saldo||"",
                  dias_atraso: it.dias_atraso||"", dias_sin_gestion: it.dias_sin_gestion||"", fase: it.fase||"",
                  observaciones: it.observaciones||""
                });
              }
            });
          });
          cacheAgendas = rows;
          if (rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="14" class="text-center text-muted">No hay resultados y el backend de lista no está disponible.</td></tr>`;
          } else {
            renderTablaAgendaDesdeCache();
          }
        } catch {
          tbody.innerHTML = `<tr><td colspan="14" class="text-center text-muted">No se pudo cargar agendas.</td></tr>`;
        }
      }
    }

    function aplicarFiltrosTablaAgenda(){ renderTablaAgendaDesdeCache(); }
    function renderTablaAgendaDesdeCache(){
      const q = (document.getElementById("filtroTextoAgenda").value || "").trim().toUpperCase();
      const fecha = (document.getElementById("filtroFechaAgenda").value || "").trim();
      const tbody = document.getElementById("agendaListaTbody");
      tbody.innerHTML = "";

      const rows = cacheAgendas.filter(r => {
        const matchFecha = !fecha || (r.fecha_prog || "").slice(0,10) === fecha;
        const matchTexto = !q || [r.socio, r.nombre, r.asesor, r.sucursal].some(v => (v ?? "").toString().toUpperCase().includes(q));
        return matchFecha && matchTexto;
      });

      if (rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="14" class="text-center text-muted">No hay resultados con los filtros.</td></tr>`;
        return;
      }

      rows.sort((a,b) =>
        (a.fecha_prog||"").localeCompare(b.fecha_prog||"") ||
        (a.sucursal||"").localeCompare(b.sucursal||"") ||
        (a.asesor||"").localeCompare(b.asesor||"")
      );

      rows.forEach((r,i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="text-center">${i+1}</td>
          <td class="mono">${r.fecha_reg||""}</td>
          <td class="text-center">${r.fecha_prog||""}</td>
          <td>${r.credito||""}</td>
          <td class="mono">${r.socio||""}</td>
          <td>${r.nombre||""}</td>
          <td>${r.sucursal||""}</td>
          <td>${r.asesor||""}</td>
          <td>${r.producto||""}</td>
          <td class="tdSaldo">${r.saldo||""}</td>
          <td class="tdCenter">${r.dias_atraso||""}</td>
          <td class="tdCenter">${r.dias_sin_gestion||""}</td>
          <td class="tdCenter">${r.fase||""}</td>
          <td>${r.observaciones||""}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
