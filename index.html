<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Sem√°foro</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; margin: 0; }
    .leaflet-tooltip {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      font-weight: bold;
      color: black;
      text-shadow: 1px 1px 2px white;
    }
    .filter-container {
      position: absolute;
      top: 10px;
      left: 50px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 6px;
      font-family: Arial, sans-serif;
    }
    .location-button {
      position: absolute;
      bottom: 20px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div class="filter-container">
  <label>Coordinador:</label>
  <select id="coordinadorFilter"></select>
  <label>Banda:</label>
  <select id="bandaFilter"></select>
</div>

<div id="map"></div>
<div class="location-button" onclick="goToMyLocation()">üìç Mi ubicaci√≥n</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const dataUrl = "datos2.csv"; // CSV subido a tu repositorio
let map;
let markersLayer;
let allData = [];

function initMap() {
  map = L.map('map').setView([20.97, -89.62], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);

  refreshMap();
}

function initFilters() {
  const coordinadorSelect = document.getElementById("coordinadorFilter");
  const bandaSelect = document.getElementById("bandaFilter");

  const coordinadores = [...new Set(allData.map(item => item.Coordinador).filter(Boolean))];
  const bandas = [...new Set(allData.map(item => item.Banda).filter(Boolean))];

  coordinadorSelect.innerHTML = '<option value="">Todos</option>' +
    coordinadores.map(c => `<option value="${c}">${c}</option>`).join("");

  bandaSelect.innerHTML = '<option value="">Todas</option>' +
    bandas.map(b => `<option value="${b}">${b}</option>`).join("");

  coordinadorSelect.addEventListener("change", refreshMap);
  bandaSelect.addEventListener("change", refreshMap);
}

function refreshMap() {
  markersLayer.clearLayers();

  const coordinadorFiltro = document.getElementById("coordinadorFilter").value;
  const bandaFiltro = document.getElementById("bandaFilter").value;

  allData
    .filter(item => 
      (!coordinadorFiltro || item.Coordinador === coordinadorFiltro) &&
      (!bandaFiltro || item.Banda === bandaFiltro)
    )
    .forEach(item => {
      if (!item.Latitud || !item.Longitud) return;

      const marker = L.marker([parseFloat(item.Latitud), parseFloat(item.Longitud)]);
      marker.bindTooltip(item.Sucursal || "", { permanent: true, direction: 'top' });
      marker.bindPopup(`
        <b>Sucursal:</b> ${item.Sucursal || ""}<br>
        <b>Coordinador:</b> ${item.Coordinador || ""}<br>
        <b>Banda:</b> ${item.Banda || ""}<br>
        <button onclick="openGoogleMaps(${item.Latitud}, ${item.Longitud})">Ir en Google Maps</button>
      `);
      markersLayer.addLayer(marker);
    });
}

function openGoogleMaps(lat, lon) {
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`, "_blank");
}

function goToMyLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      map.setView([lat, lon], 14);
      L.marker([lat, lon]).addTo(map).bindPopup("Est√°s aqu√≠").openPopup();
    });
  }
}

// üìå Cargar CSV con PapaParse
Papa.parse(dataUrl, {
  download: true,
  header: true,
  complete: function(results) {
    allData = results.data;
    initMap();
    initFilters();
  }
});
</script>

</body>
</html>
