<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa por Coordinador</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; margin: 0; }
    .sucursal-label {
      font-size: 12px;
      font-weight: bold;
      color: #000;
      text-shadow: 1px 1px 2px #fff;
    }
    .filters {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .filters select {
      margin: 5px 0;
      width: 200px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <div class="filters">
    <label>Coordinador:</label><br>
    <select id="filtroCoord"></select><br>
    <label>Sucursal:</label><br>
    <select id="filtroSucursal"></select><br>
    <label>Ejecutivo:</label><br>
    <select id="filtroEjecutivo"></select><br>
    <label>Banda:</label><br>
    <select id="filtroBanda"></select>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const dataUrl = 'datos.json'; // tu archivo JSON

    fetch(dataUrl)
      .then(res => res.json())
      .then(allData => {
        initMap(allData);
      });

    function initMap(data) {
      const map = L.map('map').setView([17.05, -96.72], 7);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OSM'
      }).addTo(map);

      function getIcon(a, d) {
        const n = parseInt(d);
        if (n === 88 || n === 89) {
          return L.divIcon({
            className: 'neon-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -30]
          });
        }
        const url = (a.trim().toUpperCase() === 'SI')
          ? 'marker-icon-green.png'
          : 'marker-icon-red.png';
        return L.icon({
          iconUrl: url,
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });
      }

      const selCoord = document.getElementById('filtroCoord'),
            selSuc   = document.getElementById('filtroSucursal'),
            selEje   = document.getElementById('filtroEjecutivo'),
            selBan   = document.getElementById('filtroBanda');

      // Lista fija de coordinadores
      const coords = ["INANME","MCRAVI","DASADI","FAPERO","MISADA","ALCNCA"];
      coords.forEach(c => {
        let opt = new Option(c, c);
        if (c === "ALCNCA") opt.selected = true; // default
        selCoord.append(opt);
      });

      let markers = [];

      function updateFilters(selCoordValue) {
        // Filtrar solo por el coordinador seleccionado
        const filtered = data.filter(r => r.Coordinador === selCoordValue);

        // Actualizar Sucursales
        selSuc.innerHTML = '';
        [...new Set(filtered.map(r => r.Sucursal))].forEach(s => selSuc.append(new Option(s, s)));

        // Actualizar Bandas
        selBan.innerHTML = '';
        [...new Set(filtered.map(r => r.Banda))].forEach(b => selBan.append(new Option(b, b)));

        // Actualizar Ejecutivos
        selEje.innerHTML = '';
        [...new Set(filtered.map(r => r.Ejecutivo))].forEach(e => selEje.append(new Option(e, e)));
      }

      function refreshMap() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        const fc = selCoord.value,
              fs = selSuc.value,
              fe = selEje.value,
              fb = selBan.value;

        let filtered = data.filter(r => r.Coordinador === fc);

        if (fs) filtered = filtered.filter(r => r.Sucursal === fs);
        if (fe) filtered = filtered.filter(r => r.Ejecutivo === fe);
        if (fb) filtered = filtered.filter(r => r.Banda === fb);

        filtered.forEach(r => {
          const lat = parseFloat(r.Latitud), lng = parseFloat(r.Longitud);
          if (!lat || !lng) return;

          const mk = L.marker([lat, lng], { icon: getIcon(r.Aceptacion, r['Dias de Atraso']) }).addTo(map);
          mk.bindPopup(
            `<strong>${r.Sucursal}</strong><br>
            Coordinador: ${r.Coordinador}<br>
            Aceptación: ${r.Aceptacion}<br>
            Días sin gestión: ${r['Dias sin Gestion']}<br>
            Línea: ${r.Linea}<br>
            Banda: ${r.Banda}<br>
            Nombre: ${r.Nombre}<br>
            Saldo: $${r['Saldo Total']}<br>
            % Pagado: ${r['Porcentaje Pagado']}%<br>
            Producto: ${r.Producto}<br>
            Días de atraso: ${r['Dias de Atraso']}<br>
            Ejecutivo: ${r.Ejecutivo}`
          );
          mk.bindTooltip(r.Sucursal, {
            permanent: true,
            direction: 'top',
            offset: [0, -10],
            className: 'sucursal-label'
          });
          markers.push(mk);
        });

        if (markers.length > 0) {
          const group = L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.2));
        }
      }

      // Inicializar filtros con ALCNCA
      updateFilters("ALCNCA");
      refreshMap();

      // Eventos
      selCoord.addEventListener('change', () => {
        updateFilters(selCoord.value);
        refreshMap();
      });
      selSuc.addEventListener('change', refreshMap);
      selEje.addEventListener('change', refreshMap);
      selBan.addEventListener('change', refreshMap);
    }
  </script>
</body>
</html>
