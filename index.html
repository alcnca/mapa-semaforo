<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Cartera</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    #map { height: 90vh; margin: 0; }
    #controls {
      padding: 10px;
      background: #f8f8f8;
      font-family: Arial, sans-serif;
    }
    select {
      margin-right: 10px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label>Coordinador: 
      <select id="coordinadorFilter">
        <option value="">Todos</option>
      </select>
    </label>
    <label>Banda: 
      <select id="bandaFilter">
        <option value="">Todas</option>
      </select>
    </label>
    <button onclick="refreshMap()">Aplicar filtros</button>
  </div>
  <div id="map"></div>

  <script>
    // Crear mapa
    const map = L.map("map").setView([20.97, -89.62], 8);

    // Capa base
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    let allData = [];
    let markersLayer = L.layerGroup().addTo(map);

    // Cargar CSV
    Papa.parse("datos.csv", {
      download: true,
      header: true,
      complete: function(results) {
        allData = results.data;
        populateFilters();
        refreshMap();
      }
    });

    // Llenar selects de filtro
    function populateFilters() {
      const coordinadorSelect = document.getElementById("coordinadorFilter");
      const bandaSelect = document.getElementById("bandaFilter");

      const coordinadores = [...new Set(allData.map(d => d.Coordinador).filter(Boolean))];
      coordinadores.forEach(c => {
        let opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        coordinadorSelect.appendChild(opt);
      });

      const bandas = [...new Set(allData.map(d => d.Banda).filter(Boolean))];
      bandas.forEach(b => {
        let opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        bandaSelect.appendChild(opt);
      });
    }

    // Refrescar mapa con filtros
    function refreshMap() {
      markersLayer.clearLayers();

      const coordinadorFiltro = document.getElementById("coordinadorFilter").value;
      const bandaFiltro = document.getElementById("bandaFilter").value;

      const filtrados = allData.filter(item => {
        return (!coordinadorFiltro || item.Coordinador === coordinadorFiltro) &&
               (!bandaFiltro || item.Banda === bandaFiltro);
      });

      filtrados.forEach(item => {
        if (!item.Latitud || !item.Longitud) return;

        const lat = parseFloat(item.Latitud);
        const lng = parseFloat(item.Longitud);
        if (isNaN(lat) || isNaN(lng)) return;

        const marker = L.marker([lat, lng]).addTo(markersLayer);

        marker.bindPopup(`
          <b>Sucursal:</b> ${item.Sucursal}<br>
          <b>Coordinador:</b> ${item.Coordinador}<br>
          <b>Ejecutivo:</b> ${item.Ejecutivo}<br>
          <b>Banda:</b> ${item.Banda}<br>
          <b>Nombre:</b> ${item.Nombre}<br>
          <b>Saldo Total:</b> ${item["Saldo Total"]}<br>
          <b>% Pagado:</b> ${item["Porcentaje Pagado"]}%<br>
          <b>Días sin gestión:</b> ${item["Dias sin Gestion"]}<br>
          <b>Días de atraso:</b> ${item["Dias de Atraso"]}<br>
          <b>Línea:</b> ${item.Linea}<br>
          <b>Producto:</b> ${item.Producto}<br>
          <button onclick="openGoogleMaps(${lat}, ${lng})">Ir en Google Maps</button>
        `);
      });
    }

    // Función para abrir Google Maps
    function openGoogleMaps(lat, lng) {
      window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
    }
  </script>
</body>
</html>
