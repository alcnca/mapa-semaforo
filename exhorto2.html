<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Exhortos / Actas Administrativas</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="container py-4">

<h1 class="mb-4">Generación de Documentos</h1>

<div class="mb-4 row g-3">
  <div class="col-md-3">
    <label class="form-label">Días mínimos sin gestión:</label>
    <input type="number" id="diasMinimos" value="30" class="form-control">
    <div class="form-text">Se usa cuando NO está activado "Solo créditos sin gestión".</div>
  </div>
  <div class="col-md-3">
    <label class="form-label">Sucursal:</label>
    <select id="sucursalSelect" class="form-select"></select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Coordinador que firma:</label>
    <select id="coordinadorSelect" class="form-select"></select>
  </div>
  <div class="col-md-3" id="subFirmanteDiv" style="display:none;">
    <label class="form-label">Firmante:</label>
    <select id="subFirmanteSelect" class="form-select"></select>
  </div>
</div>

<div class="mb-3 form-check">
  <input type="checkbox" id="soloSinGestion" class="form-check-input">
  <label class="form-check-label" for="soloSinGestion">Solo créditos sin gestión</label>
</div>

<div class="mb-4">
  <button class="btn btn-primary w-100" onclick="cargarDatos()">Aplicar</button>
</div>

<div id="contenido"></div>

<!-- Modal Vista Previa -->
<div class="modal fade" id="vistaPreviaModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vista Previa del Documento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 id="asesorTitulo"></h6>
        <table class="table table-sm table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>Crédito</th>
              <th>Nombre del Socio</th>
              <th>Saldo</th>
              <th>Días atraso</th>
              <th>Días sin gestión</th>
            </tr>
          </thead>
          <tbody id="tablaPreview"></tbody>
        </table>
        <h6 class="mt-3 text-end" id="totalPreview"></h6>
      </div>
      <div class="modal-footer gap-2">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <!-- Botones para elegir tipo justo antes de imprimir -->
        <button class="btn btn-success" id="btnGenerarExhorto">Generar Exhorto</button>
        <button class="btn btn-outline-success" id="btnGenerarActa">Generar Acta Administrativa</button>
      </div>
    </div>
  </div>
</div>

<script>
const JSON_URL = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/refs/heads/main/datos.json";
let data = [];
let creditosSeleccionados = [];
let asesorSeleccionado = "";
let sucursalSeleccionada = "";

// Nombres completos de coordinadores
const nombresCoordinadores = {
  DASADI: "DANIEL SANCHEZ DIAZ",
  FAPERO: "FRANCISCO ANTONIO PEREZ RODRIGUEZ",
  ALCNCA: "ALONSO CANCHE CASTILLO",
  MCRAVI: "MARLEN CECILIA RAMIREZ VILLANUEVA",
  INANME: "INES ANDRADE MENDEZ",
  MISADA: "MARIO ISRAEL SALINAS DAMIAN",
  OFICINA_CENTRAL: "OFICINA CENTRAL"
};

// Lista de asistentes Oficina Central
const oficinaCentral = [
  { nombre: "SANDRA LORENA PACHECO ROBLES", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
  { nombre: "ROLANDO VALERIANO HURTADO", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
  { nombre: "ANDREA ACELA MORGA DÁVILA", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
  { nombre: "GUSTAVO ESTUDILLO DE LA CRUZ", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" }
];

/* =======================
   Utils de normalización
   ======================= */
function toNumberSafe(val) {
  if (val == null) return 0;
  if (typeof val === "number") return isFinite(val) ? val : 0;
  const clean = String(val).replace(/[^0-9.-]/g, "");
  const n = parseFloat(clean);
  return isNaN(n) ? 0 : n;
}

function parseDiasSinGestion(raw) {
  if (raw == null) return null;
  const s = String(raw).toLowerCase().trim();

  const marcadoresSinGestion = new Set([
    "", "sin gestion", "sin gestión", "s/g", "sg", "sen gestion", "sin-gestion", "sin_gestion"
  ]);
  if (marcadoresSinGestion.has(s)) return null;

  const soloNum = s.replace(/[^0-9-]/g, "");
  if (soloNum === "" || soloNum === "-" || soloNum === "--") return null;

  const n = parseInt(soloNum, 10);
  return isNaN(n) ? null : n;
}

function estaSinGestion(raw) {
  return parseDiasSinGestion(raw) === null;
}

/* =======================
   Textos por tipo de documento
   (Edita libremente los del ACTA después)
   ======================= */
function getTextosDocumento(tipo, diasMinimos) {
  if (tipo === "acta") {
    const subtitulo = "Se levanta la presente ACTA ADMINISTRATIVA";
    const intro = `Con fundamento en las políticas internas y derivado de la revisión del seguimiento a la cartera, se hace constar que existen créditos con ausencia de gestión conforme a los parámetros institucionales. A continuación, se detallan los créditos detectados para su conocimiento y efectos correspondientes.`;
    const postTabla = `La presente acta administrativa tiene por objeto dejar constancia de los hechos observados y requerir la regularización inmediata de las gestiones de seguimiento, bajo apercibimiento de las medidas conducentes conforme a la normativa interna.`;
    return { titulo: "ACTA ADMINISTRATIVA", subtitulo, intro, postTabla };
  }
  const subtitulo = `Motivo: Tener créditos en su cartera con más de ${diasMinimos} días sin gestión`;
  const intro = `Me permito informarle que, derivado de la revisión del seguimiento a los créditos con más de 30 días de atraso de la cartera que usted administra, se han detectado créditos que carecen de gestión y seguimiento en el sistema, por el tiempo indicado en el motivo de la presente y que a continuación se enlistan:`;
  const postTabla = `Derivado de esta situación se detecta su falta de responsabilidad, compromiso, esmero y dedicación en la ejecución de sus responsabilidades; por dicha omisión SE LEVANTA EL PRESENTE EXHORTO para su conocimiento y cumplimiento de dichas actividades, ya que nos ayuda a llevar un sano control de la cartera, manteniendo el menor porcentaje de mora y cuidando el patrimonio de la cooperativa. Para el caso de nueva omisión se tomarán las medidas necesarias de manera inmediata.`;
  return { titulo: "EXHORTO", subtitulo, intro, postTabla };
}

/* =======================
   Carga inicial
   ======================= */
window.addEventListener("DOMContentLoaded", async () => {
  const res = await fetch(JSON_URL);
  data = await res.json();

  const selCoord = document.getElementById("coordinadorSelect");
  selCoord.innerHTML = '<option value="">-- Selecciona --</option>';
  for (let clave in nombresCoordinadores) {
    selCoord.innerHTML += `<option value="${clave}">${nombresCoordinadores[clave]}</option>`;
  }

  selCoord.addEventListener("change", () => {
    const subDiv = document.getElementById("subFirmanteDiv");
    const subSel = document.getElementById("subFirmanteSelect");
    const sucSel = document.getElementById("sucursalSelect");
    subSel.innerHTML = "";
    sucSel.innerHTML = '<option value="">-- Selecciona --</option>';

    const valorCoord = selCoord.value;

    if (valorCoord === "OFICINA_CENTRAL") {
      oficinaCentral.forEach(p => {
        subSel.innerHTML += `<option value="${p.nombre}">${p.nombre} (${p.puesto})</option>`;
      });
      subDiv.style.display = "block";
      actualizarSucursales();
    } else if (valorCoord) {
      subDiv.style.display = "none";
      if (valorCoord === "ALCNCA") {
        subDiv.style.display = "block";
        subSel.innerHTML += `<option value="ALCNCA">${nombresCoordinadores["ALCNCA"]} (Coordinador)</option>`;
        subSel.innerHTML += `<option value="IVANI">IVANI ARCOS LAINES (Gestor Regional Zona Maya)</option>`;
      }
      const sucursalesCoord = [...new Set(data.filter(d => d.Coordinador === valorCoord).map(d => d.Sucursal))];
      llenarSucursales(sucursalesCoord);
    }
  });

  actualizarSucursales();
});

function llenarSucursales(lista) {
  const selSuc = document.getElementById("sucursalSelect");
  const sucursalActual = selSuc.value;
  selSuc.innerHTML = '<option value="">-- Selecciona --</option>';
  lista.forEach(s => selSuc.innerHTML += `<option value="${s}">${s}</option>`);
  if (lista.includes(sucursalActual)) {
    selSuc.value = sucursalActual;
  } else {
    selSuc.value = "";
    sucursalSeleccionada = "";
  }
}

function actualizarSucursales() {
  const soloSin = document.getElementById("soloSinGestion").checked;
  const coord = document.getElementById("coordinadorSelect").value;

  let base = data.slice();
  if (coord && coord !== "OFICINA_CENTRAL") {
    base = base.filter(d => d.Coordinador === coord);
  }

  let sucursales;
  if (soloSin) {
    sucursales = [...new Set(
      base.filter(d => estaSinGestion(d["Dias sin Gestion"])).map(d => d.Sucursal)
    )];
  } else {
    sucursales = [...new Set(base.map(d => d.Sucursal))];
  }
  llenarSucursales(sucursales);
}

document.getElementById("soloSinGestion").addEventListener("change", actualizarSucursales);

/* =======================
   Carga y armado de tarjetas
   ======================= */
async function cargarDatos() {
  const diasFiltro = parseInt(document.getElementById("diasMinimos").value) || 30;
  const soloSinGestion = document.getElementById("soloSinGestion").checked;
  sucursalSeleccionada = document.getElementById("sucursalSelect").value;
  if (!sucursalSeleccionada) return;

  const registros = data.filter(d => {
    if (d.Sucursal !== sucursalSeleccionada) return false;

    const dias = parseDiasSinGestion(d["Dias sin Gestion"]);
    if (soloSinGestion) {
      return dias === null;
    } else {
      return (dias === null) || (typeof dias === "number" && dias >= diasFiltro);
    }
  });

  const asesores = {};
  registros.forEach(r => {
    const ejecutivo = r.Ejecutivo || "SIN ASESOR";
    if (!asesores[ejecutivo]) asesores[ejecutivo] = [];
    asesores[ejecutivo].push(r);
  });

  const cont = document.getElementById("contenido");
  cont.innerHTML = "";

  const nombresAsesores = Object.keys(asesores).sort((a, b) => a.localeCompare(b, "es"));

  if (nombresAsesores.length === 0) {
    cont.innerHTML = `<div class="alert alert-info">No se encontraron créditos con los criterios seleccionados.</div>`;
    return;
  }

  for (let asesor of nombresAsesores) {
    const total = asesores[asesor].reduce((acc, r) => acc + toNumberSafe(r["Saldo Total"]), 0);

    const card = document.createElement("div");
    card.className = "card mb-3";
    card.innerHTML = `
      <div class="card-header bg-primary text-white">${asesor}</div>
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          Créditos: ${asesores[asesor].length}<br>
          Total: $${total.toLocaleString("es-MX", { minimumFractionDigits: 2 })}
        </div>
        <button class="btn btn-warning btn-sm">Vista Previa</button>
      </div>
    `;
    card.querySelector("button").onclick = () =>
      mostrarVistaPrevia(asesor, asesores[asesor]);
    cont.appendChild(card);
  }
}

/* =======================
   Vista previa y PDF
   ======================= */
function mostrarVistaPrevia(asesor, creditos) {
  asesorSeleccionado = asesor;
  creditosSeleccionados = creditos;
  document.getElementById("asesorTitulo").textContent =
    `Asesor: ${asesor} | Sucursal: ${sucursalSeleccionada}`;

  const tbody = document.getElementById("tablaPreview");
  tbody.innerHTML = "";

  let total = 0;
  creditos.forEach(c => {
    const saldo = toNumberSafe(c["Saldo Total"]);
    total += saldo;

    const dsgParsed = parseDiasSinGestion(c["Dias sin Gestion"]);
    const dsgDisplay = (dsgParsed === null) ? "SIN GESTIÓN" : dsgParsed;

    tbody.innerHTML += `
      <tr>
        <td>${c.Linea ?? ""}</td>
        <td>${c.Nombre ?? ""}</td>
        <td>${(toNumberSafe(c["Saldo Total"])).toLocaleString("es-MX", { style: "currency", currency: "MXN" })}</td>
        <td>${c["Dias de Atraso"] ?? ""}</td>
        <td>${dsgDisplay}</td>
      </tr>
    `;
  });

  document.getElementById("totalPreview").textContent =
    `TOTAL: ${total.toLocaleString("es-MX", { style: "currency", currency: "MXN" })}`;

  // Enlazar los dos botones del modal para generar el tipo elegido
  document.getElementById("btnGenerarExhorto").onclick = () =>
    generarPDF(asesorSeleccionado, sucursalSeleccionada, creditosSeleccionados, "exhorto");

  document.getElementById("btnGenerarActa").onclick = () =>
    generarPDF(asesorSeleccionado, sucursalSeleccionada, creditosSeleccionados, "acta");

  const modal = new bootstrap.Modal(document.getElementById("vistaPreviaModal"));
  modal.show();
}

function generarPDF(asesor, sucursal, creditos, tipo) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "pt", "a4");

  // Interlineado compacto
  doc.setLineHeightFactor(1.0);

  const fecha = new Date().toLocaleDateString("es-MX", { day:"2-digit", month:"long", year:"numeric" });
  const diasMinimos = parseInt(document.getElementById("diasMinimos").value) || 30;

  const headerUrl = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/main/encabezado.png";
  const footerUrl = "https://alcnca.github.io/mapa-semaforo/piepagina.png";

  const headerImg = new Image();
  headerImg.crossOrigin = "Anonymous"; headerImg.src = headerUrl;

  const footerImg = new Image();
  footerImg.crossOrigin = "Anonymous"; footerImg.src = footerUrl;

  headerImg.onload = function () {
    doc.addImage(headerImg, "PNG", 50, 20, 500, 80);
    let y = 120;

    // Textos por tipo
    const { titulo, subtitulo, intro, postTabla } = getTextosDocumento(tipo, diasMinimos);

    doc.setFontSize(10);
    doc.text(`Fecha: ${fecha}`, 50, y);
    y += 18;

    doc.setFontSize(14);
    doc.text(titulo, 300, y, { align: "center" });
    y += 18;

    doc.setFontSize(12);
    doc.text(subtitulo, 300, y, { align: "center" });
    y += 24;

    doc.setFontSize(11);
    doc.text(`Para: ${asesor}`, 50, y);
    y += 14;
    doc.text(`Sucursal: ${sucursal}`, 50, y);
    y += 16;

    // Intro
    doc.autoTable({
      startY: y,
      body: [[intro]],
      theme: "plain",
      styles: { fontSize: 11, halign: "justify", cellPadding: 1.5 },
      margin: { left: 50, right: 50 }
    });

    y = doc.lastAutoTable.finalY + 12;

    // Tabla principal compacta
    const rows = creditos.map(c => {
      const dsgParsed = parseDiasSinGestion(c["Dias sin Gestion"]);
      const dsgDisplay = (dsgParsed === null) ? "SIN GESTIÓN" : dsgParsed;
      return [
        c.Linea ?? "",
        c.Nombre ?? "",
        toNumberSafe(c["Saldo Total"]).toLocaleString("es-MX", { style: "currency", currency: "MXN" }),
        c["Dias de Atraso"] ?? "",
        dsgDisplay
      ];
    });

    doc.autoTable({
      startY: y,
      head: [['Crédito','Nombre del Socio','Saldo','Días atraso','Días sin gestión']],
      body: rows,
      styles: { fontSize: 9, cellPadding: 1.5, lineWidth: 0.1, valign: "middle" },
      headStyles: { fillColor: [220,220,220] },
      margin: { left: 40, right: 40 }
    });

    y = doc.lastAutoTable.finalY + 10;

    // Total
    const totalSaldo = creditos.reduce((acc, c) => acc + toNumberSafe(c["Saldo Total"]), 0);
    doc.setFontSize(11);
    doc.text(`TOTAL: ${totalSaldo.toLocaleString("es-MX", { style: "currency", currency: "MXN" })}`, 50, y);
    y += 16;

    // Cierre
    doc.autoTable({
      startY: y,
      body: [[postTabla]],
      theme: "plain",
      styles: { fontSize: 11, halign: "justify", cellPadding: 1.5 },
      margin: { left: 50, right: 50 }
    });

    // ===== Firma al final del texto (NO en el pie) =====
    let firmaY = doc.lastAutoTable.finalY + 22;

    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    if (firmaY > pageHeight - 180) {
      doc.addPage();
      firmaY = 100;
    }

    // Determinar firmante
    const inicial = document.getElementById("coordinadorSelect").value;
    const subFirmante = document.getElementById("subFirmanteSelect").value || inicial;

    let nombreFirmante = "";
    let puestoFirmante = "";

    if (subFirmante === "IVANI") {
      nombreFirmante = "IVANI ARCOS LAINES";
      puestoFirmante = "Gestor Regional Zona Maya";
    } else if (inicial === "OFICINA_CENTRAL") {
      nombreFirmante = subFirmante;
      const asist = oficinaCentral.find(a => a.nombre === subFirmante);
      puestoFirmante = asist ? asist.puesto : "ASISTENTE";
    } else {
      nombreFirmante = nombresCoordinadores[subFirmante] || "NOMBRE NO DEFINIDO";
      puestoFirmante = "Coordinador de Recuperación Extrajudicial";
    }

    doc.setFontSize(11);
    doc.text("Atentamente,", pageWidth / 2, firmaY, { align: "center" });
    firmaY += 36;
    doc.text("_______________________________", pageWidth / 2, firmaY, { align: "center" });
    firmaY += 14;
    doc.text(nombreFirmante, pageWidth / 2, firmaY, { align: "center" });
    firmaY += 14;
    doc.text(puestoFirmante, pageWidth / 2, firmaY, { align: "center" });

    // Pie gráfico institucional (no afecta la firma)
    footerImg.onload = function () {
      const footerWidth = 500;
      const footerHeight = 50;
      const footerX = (pageWidth - footerWidth) / 2;
      const footerY = pageHeight - footerHeight - 20;

      const pageCount = doc.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.addImage(footerImg, "PNG", footerX, footerY, footerWidth, footerHeight);
      }

      const nombreArchivo = (tipo === "acta" ? "ACTA_ADMINISTRATIVA" : "EXHORTO");
      doc.save(`${nombreArchivo}_${asesor.replace(/ /g, "_")}.pdf`);
    };
  };
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
