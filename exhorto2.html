<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Exhorto de Asesores</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    select, input, button {
      margin: 5px;
      padding: 5px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
      width: 100%;
    }
    th, td {
      border: 1px solid #999;
      padding: 4px 6px;
      text-align: center;
    }
    th {
      background: #f0f0f0;
    }
    .oficio {
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 20px;
      background: #fafafa;
    }
    .encabezado {
      text-align: center;
      margin-bottom: 20px;
    }
    .encabezado img {
      width: 500px;
    }
    .texto-exhorto {
      text-align: justify;
      font-size: 10pt;
    }
  </style>
</head>
<body>

  <h2>Generador de Exhortos</h2>

  <label for="diasFiltro">Días sin gestión mayores a: </label>
  <input type="number" id="diasFiltro" value="30" min="0">

  <label for="sucursal">Sucursal: </label>
  <select id="sucursal"></select>

  <div id="asesoresLista"></div>

  <div id="vistaPrevia" class="oficio" style="display:none;"></div>
  <button id="btnGenerar" style="display:none;">Generar PDF</button>

  <script>
    const urlJSON = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/main/data.json";
    let data = [];
    let vistaPrevia = document.getElementById("vistaPrevia");
    let btnGenerar = document.getElementById("btnGenerar");

    // Cargar JSON
    fetch(urlJSON)
      .then(res => res.json())
      .then(json => {
        data = json;
        cargarSucursales();
      });

    // Cargar sucursales en el select
    function cargarSucursales() {
      const sucursalSelect = document.getElementById("sucursal");
      const sucursales = [...new Set(data.map(d => d.Sucursal))];
      sucursalSelect.innerHTML = sucursales.map(s => `<option value="${s}">${s}</option>`).join("");
      sucursalSelect.addEventListener("change", mostrarAsesores);
      document.getElementById("diasFiltro").addEventListener("input", mostrarAsesores);
      mostrarAsesores();
    }

    // Mostrar asesores filtrados
    function mostrarAsesores() {
      const dias = parseInt(document.getElementById("diasFiltro").value) || 0;
      const sucursal = document.getElementById("sucursal").value;
      const lista = document.getElementById("asesoresLista");

      const filtrados = data.filter(d => d.Sucursal === sucursal && parseInt(d["Dias sin Gestion"]) >= dias);

      const asesores = [...new Set(filtrados.map(d => d.Ejecutivo))];

      lista.innerHTML = asesores.map(a =>
        `<div>
          <b>${a}</b> <button onclick="vistaPreviaOficio('${a}', ${dias}, '${sucursal}')">Vista previa</button>
        </div>`
      ).join("");
    }

    // Generar vista previa
    function vistaPreviaOficio(asesor, dias, sucursal) {
      const registros = data.filter(d => d.Sucursal === sucursal && d.Ejecutivo === asesor && parseInt(d["Dias sin Gestion"]) >= dias);

      let tabla = `
        <table>
          <thead>
            <tr>
              <th>Crédito</th>
              <th>Socio</th>
              <th>Saldo</th>
              <th>Días atraso</th>
              <th>Días sin gestión</th>
            </tr>
          </thead>
          <tbody>
      `;
      registros.forEach(r => {
        tabla += `
          <tr>
            <td>${r.Linea}</td>
            <td>${r.Nombre}</td>
            <td>${r["Saldo Total"]}</td>
            <td>${r["Dias de Atraso"]}</td>
            <td>${r["Dias sin Gestion"]}</td>
          </tr>
        `;
      });
      tabla += "</tbody></table>";

      const exhortoTexto = `
        <p class="texto-exhorto">
          Derivado de esta situación se detecta su falta de responsabilidad, compromiso, esmero y dedicación en la ejecución de sus responsabilidades, 
          por dicha omisión <b>SE LEVANTA EL PRESENTE EXHORTO</b>, para su conocimiento, realizar y para realizar el cumplimiento de dichas actividades, 
          ya que nos ayuda a llevar un sano control de la cartera, mediante sus etapas de recuperación manteniendo el menor porcentaje de mora en la cartera, 
          cumpliendo con los objetivos a nivel dirección y cuidando el patrimonio de la cooperativa.<br/><br/>
          Para el caso de nueva omisión se tomarán las medidas necesarias de manera inmediata.
        </p>
      `;

      vistaPrevia.innerHTML = `
        <div class="encabezado">
          <img src="https://raw.githubusercontent.com/alcnca/mapa-semaforo/main/encabezado.png" alt="Encabezado">
        </div>
        <h3>Exhorto al Asesor: ${asesor}</h3>
        <h4>Sucursal: ${sucursal}</h4>
        ${tabla}
        ${exhortoTexto}
      `;

      vistaPrevia.style.display = "block";
      btnGenerar.style.display = "inline-block";

      btnGenerar.onclick = () => generarPDF(asesor, sucursal, tabla, exhortoTexto);
    }

    // Generar PDF
    async function generarPDF(asesor, sucursal, tabla, exhortoTexto) {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "pt", "a4");

      // Encabezado
      const imgUrl = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/main/encabezado.png";
      const img = new Image();
      img.src = imgUrl;
      img.onload = function() {
        pdf.addImage(img, "PNG", 50, 20, 500, 80);

        pdf.setFontSize(12);
        pdf.text(`Exhorto al Asesor: ${asesor}`, 50, 120);
        pdf.text(`Sucursal: ${sucursal}`, 50, 140);

        // Texto y tabla como HTML
        pdf.html(`<div>${tabla}${exhortoTexto}</div>`, {
          x: 50,
          y: 160,
          html2canvas: { scale: 0.5 },
          callback: function () {
            pdf.save(`Exhorto_${asesor}.pdf`);
          }
        });
      };
    }
  </script>
</body>
</html>

