<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Exhortos de Créditos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="container py-4">

<h1 class="mb-4">Exhortos de Créditos</h1>

<div class="mb-4 row">
  <div class="col-md-4">
    <label class="form-label">Días mínimos sin gestión:</label>
    <input type="number" id="diasMinimos" value="30" class="form-control">
  </div>
  <div class="col-md-4">
    <label class="form-label">Sucursal:</label>
    <select id="sucursalSelect" class="form-select"></select>
  </div>
  <div class="col-md-4 d-flex align-items-end">
    <button class="btn btn-primary w-100" onclick="cargarDatos()">Aplicar</button>
  </div>
</div>

<div id="contenido"></div>

<div class="modal fade" id="vistaPreviaModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vista Previa del Oficio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 id="asesorTitulo"></h6>
        <table class="table table-sm table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>Crédito</th>
              <th>Nombre del Socio</th>
              <th>Saldo</th>
              <th>Días atraso</th>
              <th>Días sin gestión</th>
            </tr>
          </thead>
          <tbody id="tablaPreview"></tbody>
        </table>
        <h6 class="mt-3 text-end" id="totalPreview"></h6>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button class="btn btn-success" id="btnGenerarPDF">Generar PDF</button>
      </div>
    </div>
  </div>
</div>

<script>
const JSON_URL = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/refs/heads/main/datos.json";
let data = [];
let creditosSeleccionados = [];
let asesorSeleccionado = "";
let sucursalSeleccionada = "";

async function cargarDatos() {
  const diasFiltro = parseInt(document.getElementById("diasMinimos").value) || 30;
  sucursalSeleccionada = document.getElementById("sucursalSelect").value;

  if (data.length === 0) {
    const res = await fetch(JSON_URL);
    data = await res.json();

    const sucursales = [...new Set(data.map(d => d.Sucursal))];
    const sel = document.getElementById("sucursalSelect");
    sel.innerHTML = '<option value="">-- Selecciona --</option>';
    sucursales.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
  }

  if (!sucursalSeleccionada) return;

  const registros = data.filter(d =>
    d.Sucursal === sucursalSeleccionada &&
    parseInt(d["Dias sin Gestion"]) > diasFiltro
  );

  const asesores = {};
  registros.forEach(r => {
    if (!asesores[r.Ejecutivo]) asesores[r.Ejecutivo] = [];
    asesores[r.Ejecutivo].push(r);
  });

  const cont = document.getElementById("contenido");
  cont.innerHTML = "";

  for (let asesor in asesores) {
    const total = asesores[asesor].reduce((acc, r) =>
      acc + (parseFloat(r["Saldo Total"].replace(/[$,]/g, "")) || 0), 0);

    const card = document.createElement("div");
    card.className = "card mb-3";
    card.innerHTML = `
      <div class="card-header bg-primary text-white">${asesor}</div>
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          Créditos: ${asesores[asesor].length}<br>
          Total: $${total.toLocaleString("es-MX", { minimumFractionDigits: 2 })}
        </div>
        <button class="btn btn-warning btn-sm">Vista Previa</button>
      </div>
    `;

    card.querySelector("button").onclick = () =>
      mostrarVistaPrevia(asesor, asesores[asesor]);

    cont.appendChild(card);
  }
}

function mostrarVistaPrevia(asesor, creditos) {
  asesorSeleccionado = asesor;
  creditosSeleccionados = creditos;

  document.getElementById("asesorTitulo").textContent =
    `Asesor: ${asesor} | Sucursal: ${sucursalSeleccionada}`;

  const tbody = document.getElementById("tablaPreview");
  tbody.innerHTML = "";

  let total = 0;
  creditos.forEach(c => {
    const saldo = parseFloat(c["Saldo Total"].replace(/[$,]/g, "")) || 0;
    total += saldo;
    tbody.innerHTML += `
      <tr>
        <td>${c.Linea}</td>
        <td>${c.Nombre}</td>
        <td>${c["Saldo Total"]}</td>
        <td>${c["Dias de Atraso"]}</td>
        <td>${c["Dias sin Gestion"]}</td>
      </tr>
    `;
  });

  document.getElementById("totalPreview").textContent =
    `TOTAL: $${total.toLocaleString("es-MX", { minimumFractionDigits: 2 })}`;

  const modal = new bootstrap.Modal(document.getElementById("vistaPreviaModal"));
  modal.show();

  document.getElementById("btnGenerarPDF").onclick = () =>
    generarPDF(asesorSeleccionado, sucursalSeleccionada, creditosSeleccionados);
}

function generarPDF(asesor, sucursal, creditos) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const fecha = new Date().toLocaleDateString("es-MX", { day:"2-digit", month:"long", year:"numeric" });
  let y = 20;

  // Encabezado de empresa y fecha
  doc.setFontSize(16);
  doc.text("Cooperativa Acreimex", 105, y, { align: "center" });
  y += 10;
  doc.setFontSize(10);
  doc.text(`Izamal, Yucatan a ${fecha}`, 20, y, { align: "right" });
  y += 10;

  // Título
  doc.setFontSize(14);
  doc.text("OFICIO DE SEGUIMIENTO", 105, y, { align: "center" });
  y += 10;
  doc.setFontSize(12);
  doc.text(`Asunto: Exhorto por Créditos con más de ${document.getElementById("diasMinimos").value} días sin gestión`, 105, y, { align: "center" });
  y += 15;

  // Destinatario
  doc.text(`Para: ${asesor}`, 15, y);
  y += 7;
doc.text(`Asesor de Credito y Recuperacion Individual`, 15, y);
  y += 7;
doc.text(`Sucursal: ${sucursal}`, 15, y);
  y += 7;
doc.text(`Presente`, 15, y);
  y += 7;

  y += 7;

  // Tabla con créditos usando autoTable
  const rows = creditos.map(c => [
    c.Linea, c.Nombre, c["Saldo Total"], c["Dias de Atraso"], c["Dias sin Gestion"]
  ]);

  doc.autoTable({
    startY: y,
    head: [['Crédito','Nombre del Socio','Saldo','Días atraso','Días sin gestión']],
    body: rows,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [220,220,220] },
    margin: { left: 20, right: 20 }
  });

  y = doc.lastAutoTable.finalY + 10;

  // Total
  const totalSaldo = creditos.reduce((acc, c) =>
    acc + (parseFloat(c["Saldo Total"].replace(/[$,]/g, "")) || 0), 0);
  doc.setFontSize(12);
  doc.text(`TOTAL: $${totalSaldo.toLocaleString("es-MX", { minimumFractionDigits: 2 })}`, 15, y);
  y += 15;

  // Exhorto y espacio para firma
  doc.setFontSize(11);
  doc.text("Debido a que el Asesor de Crédito y Recuperación es el principal responsable de ejecutar de manera correcta las etapas del otorgamiento del crédito, ya que el proceso crediticio no termina con el desembolso, sino hasta la liquidación y recuperación de este. Por lo tanto, está obligado a dar puntual seguimiento y gestión a los créditos que se encuentren en mora, evitando en todo momento el deterioro de su cartera y coadyuvando a tos logros de los objetivos de la sucursal y de la Cooperativa, cumpliendo con la filosofía institucional y la normatividad vigente.", 15, y);
  y += 20;
  doc.text("Alonso Canche Castillo", 20, y);
  y += 5;
  doc.text("Firma del Coordinador", 20, y);

  doc.save(`oficio_${asesor.replace(/ /g,"_")}.pdf`);
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
