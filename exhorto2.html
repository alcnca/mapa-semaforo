<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generar PDF Exhortos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="p-3">

<div class="container">
  <h3>Generador de PDF - Exhortos</h3>
  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label">Sucursal:</label>
      <select id="sucursalSelect" class="form-select"></select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Días mínimos sin gestión:</label>
      <input type="number" id="diasMinimos" class="form-control" value="30">
    </div>
    <div class="col-md-4">
      <label class="form-label">Firmante:</label>
      <select id="coordinadorSelect" class="form-select"></select>
    </div>
  </div>

  <div id="subFirmanteDiv" class="row mb-3" style="display:none;">
    <div class="col-md-6">
      <label class="form-label">Selecciona Firmante:</label>
      <select id="subFirmanteSelect" class="form-select"></select>
    </div>
  </div>

  <button class="btn btn-primary" onclick="generarPDF()">Generar PDF</button>
</div>

<script>
const { jsPDF } = window.jspdf;
const JSON_URL = "datos.json";

let data = [];
let coordinadores = {};

// Lista fija de asistentes Oficina Central
const oficinaCentral = [
  { nombre: "SANDRA LORENA PACHECO ROBLES", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
  { nombre: "ROLANDO VALERIANO HURTADO", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
  { nombre: "ANDREA ACELA MORGA DÁVILA", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
  { nombre: "GUSTAVO ESTUDILLO DE LA CRUZ", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" }
];

// Cargar datos al inicio
window.addEventListener("DOMContentLoaded", cargarDatos);

async function cargarDatos() {
  const res = await fetch(JSON_URL);
  data = await res.json();

  // Sucursales únicas
  const sucursales = [...new Set(data.map(d => d.Sucursal))];
  const selSuc = document.getElementById("sucursalSelect");
  selSuc.innerHTML = '<option value="">-- Selecciona --</option>';
  sucursales.forEach(s => selSuc.innerHTML += `<option value="${s}">${s}</option>`);

  // Coordinadores únicos desde JSON
  coordinadores = {};
  data.forEach(d => {
    if (d.Coordinador && !coordinadores[d.Coordinador]) {
      coordinadores[d.Coordinador] = d.CoordinadorNombre || d.Coordinador;
    }
  });

  // Agregar también la opción "OFICINA CENTRAL"
  coordinadores["OFICINA_CENTRAL"] = "OFICINA CENTRAL";

  // Llenar select coordinadores
  const selCoord = document.getElementById("coordinadorSelect");
  selCoord.innerHTML = '<option value="">-- Selecciona --</option>';
  for (let inicial in coordinadores) {
    selCoord.innerHTML += `<option value="${inicial}">${coordinadores[inicial]}</option>`;
  }

  // Evento de cambio coordinador
  selCoord.addEventListener("change", () => {
    const subDiv = document.getElementById("subFirmanteDiv");
    const subSel = document.getElementById("subFirmanteSelect");
    const sucSel = document.getElementById("sucursalSelect");
    subSel.innerHTML = "";

    if (selCoord.value === "OFICINA_CENTRAL") {
      subDiv.style.display = "block";
      // Cargar todos los asistentes
      oficinaCentral.forEach(p => {
        subSel.innerHTML += `<option value="${p.nombre}">${p.nombre} (${p.puesto})</option>`;
      });
      // Mostrar todas las sucursales
      const todasSucursales = [...new Set(data.map(d => d.Sucursal))];
      sucSel.innerHTML = '<option value="">-- Selecciona --</option>';
      todasSucursales.forEach(s => sucSel.innerHTML += `<option value="${s}">${s}</option>`);
    } else if (selCoord.value) {
      // Para otros coordinadores
      subDiv.style.display = (selCoord.value === "ALCNCA") ? "block" : "none";
      if (selCoord.value === "ALCNCA") {
        subSel.innerHTML += `<option value="ALCNCA">${coordinadores["ALCNCA"]} (Coordinador)</option>`;
        subSel.innerHTML += `<option value="IVANI">IVANI ARCOS LAINES (Gestor Regional ZONA MAYA)</option>`;
      }

      // Filtrar sucursales según coordinador
      const sucursalesCoord = [...new Set(data.filter(d => d.Coordinador === selCoord.value).map(d => d.Sucursal))];
      sucSel.innerHTML = '<option value="">-- Selecciona --</option>';
      sucursalesCoord.forEach(s => sucSel.innerHTML += `<option value="${s}">${s}</option>`);
    } else {
      subDiv.style.display = "none";
      sucSel.innerHTML = '<option value="">-- Selecciona --</option>';
    }
  });
}

function generarPDF() {
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  doc.text("Reporte de Créditos en Atraso", pageWidth / 2, 20, { align: "center" });
  doc.autoTable({
    head: [["Socio", "Crédito", "Días atraso"]],
    body: [
      ["JUAN PEREZ", "12345", "40"],
      ["MARIA LOPEZ", "67890", "35"],
    ],
    startY: 30,
    styles: { fontSize: 9 }
  });

  let finalY = doc.lastAutoTable.finalY || 50;
  if (finalY > pageHeight - 120) {
    doc.addPage();
    finalY = 100;
  }

  let inicial = document.getElementById("coordinadorSelect").value;
  let subFirmante = document.getElementById("subFirmanteSelect").value;
  let nombreCoordinador = "";
  let puesto = "COORDINADOR DE RECUPERACIÓN EXTRAJUDICIAL";

  if (inicial === "OFICINA_CENTRAL") {
    const asistente = oficinaCentral.find(p => p.nombre === subFirmante);
    if (asistente) {
      nombreCoordinador = asistente.nombre;
      puesto = asistente.puesto;
    }
  } else if (inicial === "ALCNCA" && subFirmante === "IVANI") {
    nombreCoordinador = "IVANI ARCOS LAINES";
    puesto = "GESTOR REGIONAL ZONA MAYA";
  } else {
    nombreCoordinador = coordinadores[inicial] || "NOMBRE NO DEFINIDO";
  }

  let firmaY = finalY + 40;
  doc.setFontSize(11);
  doc.text("Atentamente,", pageWidth / 2, firmaY, { align: "center" });

  firmaY += 40;
  doc.text("_______________________________", pageWidth / 2, firmaY, { align: "center" });

  firmaY += 15;
  doc.text(nombreCoordinador, pageWidth / 2, firmaY, { align: "center" });

  firmaY += 15;
  doc.text(puesto, pageWidth / 2, firmaY, { align: "center" });

  doc.save("exhorto.pdf");
}
</script>

</body>
</html>
