<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Exhortos de Créditos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">

  <h1 class="mb-4">Exhortos de Créditos</h1>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Días mínimos de atraso:</label>
      <input type="number" id="diasMinimos" value="30" class="form-control">
    </div>
    <div class="col-md-4">
      <label class="form-label">Sucursal:</label>
      <select id="sucursalSelect" class="form-select">
        <option value="">-- Selecciona una sucursal --</option>
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-primary w-100" onclick="mostrarAsesores()">Aplicar</button>
    </div>
  </div>

  <div id="contenido"></div>

<script>
const JSON_URL = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/refs/heads/main/datos.json"; // <-- tu JSON RAW en GitHub
let data = [];

// Cargar datos y llenar sucursales
async function cargarDatos() {
  const res = await fetch(JSON_URL);
  data = await res.json();

  const sucursales = [...new Set(data.map(item => item.Sucursal))].sort();
  const select = document.getElementById("sucursalSelect");

  sucursales.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    select.appendChild(opt);
  });
}

// Mostrar asesores según sucursal y días
function mostrarAsesores() {
  const diasFiltro = parseInt(document.getElementById("diasMinimos").value) || 30;
  const sucursalSel = document.getElementById("sucursalSelect").value;

  const cont = document.getElementById("contenido");
  cont.innerHTML = "";

  if (!sucursalSel) {
    cont.innerHTML = `<div class="alert alert-warning">Selecciona una sucursal.</div>`;
    return;
  }

  const registros = data.filter(c => c.Sucursal === sucursalSel && parseInt(c["Dias de Atraso"]) > diasFiltro);

  if (registros.length === 0) {
    cont.innerHTML = `<div class="alert alert-info">No hay créditos con más de ${diasFiltro} días en esta sucursal.</div>`;
    return;
  }

  // Agrupar por Ejecutivo (asesor)
  const asesores = {};
  registros.forEach(c => {
    if (!asesores[c.Ejecutivo]) asesores[c.Ejecutivo] = [];
    asesores[c.Ejecutivo].push(c);
  });

  const lista = document.createElement("ul");
  lista.className = "list-group";

  for (let asesor in asesores) {
    const creditos = asesores[asesor];
    const total = creditos.reduce((acc, c) => acc + (parseFloat(c["Saldo Total"].replace(/[$,]/g, "")) || 0), 0);

    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center flex-wrap";

    const info = document.createElement("div");
    info.innerHTML = `<b>${asesor}</b><br>
      Créditos: ${creditos.length} | Total: $${total.toLocaleString("es-MX", {minimumFractionDigits:2})}`;

    const btn = document.createElement("button");
    btn.className = "btn btn-danger btn-sm mt-2 mt-sm-0";
    btn.textContent = "Exhortar";
    btn.onclick = () => generarPDF(asesor, sucursalSel, creditos, diasFiltro);

    li.appendChild(info);
    li.appendChild(btn);
    lista.appendChild(li);
  }

  cont.appendChild(lista);
}

// Generar PDF
function generarPDF(asesor, sucursal, creditos, dias) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let y = 20;
  doc.setFontSize(14);
  doc.text("OFICIO DE SEGUIMIENTO", 105, y, { align: "center" });
  y += 10;
  doc.setFontSize(12);
  doc.text(`Asunto: Créditos con más de ${dias} días de atraso`, 105, y, { align: "center" });

  y += 20;
  doc.text(`Asesor: ${asesor}`, 20, y);
  y += 10;
  doc.text(`Sucursal: ${sucursal}`, 20, y);

  y += 20;
  doc.text("Lista de créditos:", 20, y);
  y += 10;

  doc.setFontSize(10);
  let total = 0;
  creditos.forEach(c => {
    doc.text(`Días atraso: ${c["Dias de Atraso"]} | Saldo: ${c["Saldo Total"]} | Banda: ${c["Banda"]}`, 20, y);
    y += 7;
    total += parseFloat(c["Saldo Total"].replace(/[$,]/g, "")) || 0;
  });

  y += 10;
  doc.setFontSize(12);
  doc.text(`TOTAL: $${total.toLocaleString("es-MX", { minimumFractionDigits: 2 })}`, 20, y);

  y += 20;
  doc.setFontSize(11);
  doc.text("Se exhorta al asesor a dar puntual seguimiento a los créditos enlistados.", 20, y);

  doc.save(`oficio_${asesor.replace(/ /g, "_")}.pdf`);
}

// Cargar datos al inicio
cargarDatos();
</script>

</body>
</html>

