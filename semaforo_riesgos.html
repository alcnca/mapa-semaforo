<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mapa Sem치foro</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; margin: 0; }

    .leaflet-tooltip {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    .sucursal-label {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      text-shadow: none !important;
      color: black !important;
      font-size: 10px;
      font-weight: bold;
    }

    .neon-marker {
      width: 10px;
      height: 10px;
      background: red;
      border-radius: 50%;
      box-shadow: 0 0 3px red, 0 0 6px red;
      animation: pulse 1.5s infinite;
      border: 1px solid white;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 1px red, 0 0 3px red; }
      50% { box-shadow: 0 0 5px red, 0 0 10px red; }
      100% { box-shadow: 0 0 1px red, 0 0 3px red; }
    }

    .filtros {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 5px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 13px;
    }

    /* Bot칩n Home */
    .home-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 1000;
    }
    .home-btn:hover {
      background: #f0f0f0;
    }
    .home-btn svg {
      width: 20px;
      height: 20px;
      fill: black;
    }

    select { margin-right: 5px; }
  </style>
</head>
<body>

<div class="filtros">
  <label>Sucursal: <select id="filtroSucursal"><option value="TODAS">Todas</option></select></label>
  <label>Ejecutivo: <select id="filtroEjecutivo"><option value="TODOS">Todos</option></select></label>
  <label>Banda: <select id="filtroBanda"><option value="TODAS">Todas</option></select></label>
  <div id="ultima-actualizacion" style="margin-top:5px; font-size:12px; color:#333;"></div>
</div>

<!-- Bot칩n Home -->
<div class="home-btn" onclick="window.location.href='index.html'">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
    <path d="M280.4 148.3L96 300.1V464c0 8.8 
    7.2 16 16 16l112-.3c8.8 0 16-7.2 
    16-16V368c0-8.8 7.2-16 
    16-16h64c8.8 0 16 7.2 
    16 16v95.7c0 8.8 7.2 16 
    16 16l112 .3c8.8 0 16-7.2 
    16-16V300L295.6 148.3c-5.6-4.7-13.7-4.7-19.2 0zM571.6 
    251.5L488 182.6V44c0-6.6-5.4-12-12-12h-52c-6.6 
    0-12 5.4-12 12v72.6L318.5 43c-27.2-22.6-68.2-22.6-95.4 
    0L4.4 251.5c-5.1 4.2-5.8 11.8-1.6 
    16.9l21.4 25.6c4.2 5.1 11.8 5.8 
    16.9 1.6L64 261.2V464c0 26.5 
    21.5 48 48 48h352c26.5 0 48-21.5 
    48-48V261.2l23.8 20.3c5.1 4.2 
    12.7 3.5 16.9-1.6l21.4-25.6c4.2-5.1 
    3.5-12.7-1.5-16.8z"/>
  </svg>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  const coordinadorClave = getParam('coord') || 'alcnca';
  const dataUrl = 'riesgos.json';

  fetch(dataUrl)
    .then(res => {
      // 游댳 Obtener fecha de 칰ltima modificaci칩n
      const lastModified = res.headers.get("Last-Modified");
      if (lastModified) {
        const fecha = new Date(lastModified);
        // Mostrar solo la fecha en formato espa침ol (ej. 29 de agosto de 2025)
        const fechaFormateada = fecha.toLocaleDateString("es-MX", {
          day: "numeric",
          month: "long",
          year: "numeric"
        });
        document.getElementById("ultima-actualizacion").innerText =
          "칔ltima actualizaci칩n: " + fechaFormateada;
      }
      return res.json();
    })
    .then(allData => {
      const data = allData.filter(r => r.Coordinador.toLowerCase() === coordinadorClave.toLowerCase());
      initMap(data);
    });

  function initMap(data) {
    const map = L.map('map').setView([17.05, -96.72], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '춸 OSM'
    }).addTo(map);

    function getIcon(a, d) {
      const n = parseInt(d);
      if (n === 88 || n === 89) {
        return L.divIcon({
          className: 'neon-marker',
          iconSize: [30, 30],
          iconAnchor: [15, 30],
          popupAnchor: [0, -30]
        });
      }
      const url = (a.trim().toUpperCase() === 'SI')
        ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png'
        : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
      return L.icon({
        iconUrl: url,
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    const selSuc = document.getElementById('filtroSucursal'),
          selEje = document.getElementById('filtroEjecutivo'),
          selBan = document.getElementById('filtroBanda');

    // Sucursales
    const sucursales = [...new Set(data.map(r => r.Sucursal))];
    sucursales.forEach(s => selSuc.append(new Option(s, s)));

    // Bandas
    const bandas = [...new Set(data.map(r => r.Banda))];
    bandas.forEach(b => selBan.append(new Option(b, b)));

    let markers = [];

    function updateExecOptions(selSucValue) {
      selEje.innerHTML = '<option value="TODOS">Todos</option>';
      const execs = selSucValue === 'TODAS'
        ? [...new Set(data.map(r => r.Ejecutivo))]
        : [...new Set(data.filter(r => r.Sucursal === selSucValue).map(r => r.Ejecutivo))];
      execs.forEach(e => selEje.append(new Option(e, e)));
    }

    function refreshMap() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      const fs = selSuc.value, fe = selEje.value, fb = selBan.value;

      data.forEach(r => {
        if ((fs !== 'TODAS' && r.Sucursal !== fs) ||
            (fe !== 'TODOS' && r.Ejecutivo !== fe) ||
            (fb !== 'TODAS' && r.Banda !== fb)) return;

        const lat = parseFloat(r.Latitud), lng = parseFloat(r.Longitud);
        if (!lat || !lng) return;
        const mk = L.marker([lat, lng], { icon: getIcon(r.Aceptacion, r['Dias de Atraso']) }).addTo(map);
        mk.bindPopup(
          `<strong>${r.Sucursal}</strong><br>
          Aceptaci칩n: ${r.Aceptacion}<br>
          D칤as sin gesti칩n: ${r['Dias sin Gestion']}<br>
          L칤nea: ${r.Linea}<br>
          Nombre: ${r.Nombre}<br>
          Saldo: $${r['Saldo Total']}<br>
          % Pagado: ${r['Porcentaje Pagado']}%<br>
          Producto: ${r.Producto}<br>
          D칤as de atraso: ${r['Dias de Atraso']}<br>
          Ejecutivo: ${r.Ejecutivo}<br>
          Banda: ${r.Banda}`
        );
        mk.bindTooltip(r.Sucursal, {
          permanent: true,
          direction: 'top',
          offset: [0, -10],
          className: 'sucursal-label'
        });
        markers.push(mk);
      });

      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    selSuc.addEventListener('change', () => {
      updateExecOptions(selSuc.value);
      refreshMap();
    });
    selEje.addEventListener('change', refreshMap);
    selBan.addEventListener('change', refreshMap);

    updateExecOptions('TODAS');
    refreshMap();
  }
</script>
</body>
</html>
