<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Exhortos / Actas + Agenda (GAS + Google Sheets)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    .table.table-sm th, .table.table-sm td { font-size: 10px; line-height: 1.10; }
    #tablaPreview td:nth-child(1), #tablaPreview td:nth-child(2) { text-align: center; }
    #tablaPreview td:nth-child(3), #tablaPreview td:nth-child(4) { text-align: left; }
    #tablaPreview td:nth-child(5) { text-align: right; }
    #tablaPreview td:nth-child(6), #tablaPreview td:nth-child(7), #tablaPreview td:nth-child(8), #tablaPreview td:nth-child(9), #tablaPreview td:nth-child(10) { text-align: center; }
    .tdSaldo { text-align: right; }
    .tdCenter { text-align: center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 10px; }
    .badge + .badge { margin-left: 4px; }

    /* ===== Estilo específico para la vista previa ===== */
    #vistaPreviaModal .table { table-layout: fixed; }
    #vistaPreviaModal th, #vistaPreviaModal td {
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    /* Alineaciones de las NUEVAS columnas */
    #tablaPreview td:nth-child(11) { text-align: left; }   /* Realizó Última Gestión */
    #tablaPreview td:nth-child(12) { text-align: center; } /* Fecha Última Gestión */
    #tablaPreview td:nth-child(13) { text-align: left; }   /* Tipo de Gestión */

    /* Tamaños sugeridos (si quieres subir/bajar fuente de la vista previa) */
    #vistaPreviaModal .table.table-sm th,
    #vistaPreviaModal .table.table-sm td { font-size: 11px; line-height: 1.15; }
    #asesorTitulo { font-size: 13px; }
    #totalPreview { font-size: 12px; }
    #vistaPreviaModal .estatus-cell .badge { font-size: 10px; }
  </style>
</head>
<body class="container py-4">
  <h1 class="mb-3">Seguimiento SemiAutomático</h1>

  <!-- Filtros principales -->
  <div class="mb-4 row g-3">
    <div class="col-md-3">
      <label class="form-label">Cartera a revisar:</label>
      <select id="carteraSelect" class="form-select">
        <option value="">-- Selecciona --</option>
        <option value="TODAS">Todas</option>
        <option value="ADMIN">Cartera Administrativa (Fase: Administrativa)</option>
        <option value="EXTRA">Cartera Extrajudicial (Fase: Extrajudicial)</option>
      </select>
    </div>
    <div class="col-md-3" id="mostrarDiv" style="display:none;">
      <label class="form-label">¿Qué mostrar?</label>
      <select id="mostrarSelect" class="form-select">
        <option value="SIN">Solo créditos sin gestión</option>
        <option value="TODOS">Todos</option>
        <option value="PAGOS_UNICOS">Pagos únicos</option>
        <option value="PAGOS_UNICOS_POR_VENCER">Pago único por vencer (fecha de pago)</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Coordinador que firma:</label>
      <select id="coordinadorSelect" class="form-select"></select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Sucursal:</label>
      <select id="sucursalSelect" class="form-select"></select>
    </div>
    <div class="col-md-3" id="subFirmanteDiv" style="display: none">
      <label class="form-label">Firmante (Oficina Central):</label>
      <select id="subFirmanteSelect" class="form-select"></select>
    </div>
    <div class="col-md-3" id="diasMinimosDiv" style="display:none;">
      <label class="form-label">Días transcurridos desde la última gestión:</label>
      <input type="number" id="diasMinimos" value="30" class="form-control" />
      <div class="form-text">Aplica sólo si elegiste “Todos”.</div>
    </div>
  </div>

  <div class="mb-3 d-grid">
    <button class="btn btn-primary" id="btnAplicar">Aplicar</button>
  </div>

  <!-- Botón global para revisar/gestionar la agenda -->
  <div class="mb-3">
    <button class="btn btn-outline-dark w-100" id="btnAbrirAgenda">Revisar Agenda Guardada</button>
  </div>

  <div id="contenido"></div>

  <!-- Modal de Vista Previa -->
  <div class="modal fade" id="vistaPreviaModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Vista Previa del Documento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 id="asesorTitulo"></h6>

          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <!-- Colgroup para repartir anchos (suma 100%) -->
              <colgroup>
                <col style="width:7%"><!-- Crédito -->
                <col style="width:8%"><!-- Producto -->
                <col style="width:7%"><!-- Socio -->
                <col style="width:16%"><!-- Nombre del Socio (más ancho) -->
                <col style="width:9%"><!-- Saldo -->
                <col style="width:6%"><!-- Días atraso -->
                <col style="width:6%"><!-- Días sin gestión -->
                <col style="width:7%"><!-- Fase -->
                <col style="width:7%"><!-- Venc. -->
                <col style="width:7%"><!-- Realizó Última Gestión -->
                <col style="width:7%"><!-- Fecha Última Gestión -->
                <col style="width:8%"><!-- Tipo de Gestión -->
                <col style="width:5%"><!-- Estatus -->
              </colgroup>

              <thead class="table-dark text-center">
                <tr>
                  <th>Crédito</th>
                  <th>Producto</th>
                  <th>Socio</th>
                  <th>Nombre del Socio</th>
                  <th>Saldo</th>
                  <th>Días atraso</th>
                  <th>Días sin gestión</th>
                  <th>Fase</th>
                  <th>Venc.</th>
                  <!-- NUEVAS -->
                  <th>Realizó Última Gestión</th>
                  <th>Fecha Última Gestión</th>
                  <th>Tipo de Gestión</th>
                  <!-- /NUEVAS -->
                  <th>Estatus</th>
                </tr>
              </thead>
              <tbody id="tablaPreview"></tbody>
            </table>
          </div>

          <h6 class="mt-3 text-center" id="totalPreview"></h6>
        </div>
        <div class="modal-footer gap-2">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button class="btn btn-success" id="btnGenerarExhorto">Generar Exhorto</button>
          <button class="btn btn-outline-success" id="btnGenerarActa">Generar Acta Administrativa</button>
          <button class="btn btn-outline-primary" id="btnAgendaPreview">Crear agenda de estos socios</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Crear agenda y guardar -->
  <div class="modal fade" id="agendaModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Agenda de seguimiento — <span id="agendaTitulo"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="alert alert-info mb-3">
            Completa la <strong>Fecha programada</strong> y <strong>Observaciones</strong> por socio.
          </div>

          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">Quién firma (automático)</label>
              <input id="agendaRealizaRO" class="form-control" readonly />
            </div>
            <div class="col-md-6">
              <label class="form-label">Fecha de registro (automática)</label>
              <input id="agendaFechaRegistroRO" class="form-control mono" readonly />
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-dark text-center">
                <tr>
                  <th>#</th>
                  <th>Crédito</th>
                  <th>Socio</th>
                  <th>Nombre</th>
                  <th>Sucursal</th>
                  <th>Asesor</th>
                  <th>Producto</th>
                  <th>Saldo</th>
                  <th>Días atraso</th>
                  <th>Días sin gestión</th>
                  <th>Fase</th>
                  <th>Fecha programada</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody id="agendaTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer gap-2">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnGuardarAgenda">Guardar en Agenda</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Visualizar compromisos -->
  <div class="modal fade" id="agendaListaModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Agenda guardada</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-2 mb-3">
            <div class="col-md-3">
              <button class="btn btn-outline-primary w-100" id="btnCargarHoy">CARGAR AGENDA</button>
            </div>
            <div class="col-md-3">
              <input id="filtroFechaAgenda" class="form-control" type="date" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Usuario (creador)</label>
              <input id="filtroUsuarioAgendaInput" class="form-control" placeholder="Ej. ALCNCA" />
              <div class="form-text">Por defecto usamos el código del “Coordinador que firma”.</div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-dark text-center">
                <tr>
                  <th>#</th>
                  <th>Fecha registro</th>
                  <th>Fecha prog.</th>
                  <th>Crédito</th>
                  <th>Socio</th>
                  <th>Nombre</th>
                  <th>Sucursal</th>
                  <th>Asesor</th>
                  <th>Producto</th>
                  <th>Saldo</th>
                  <th>Días atraso</th>
                  <th>Días sin gestión</th>
                  <th>Fase</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody id="agendaListaTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="modal-footer gap-2">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===================== CONFIG GAS ===================== */
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz0_ggNCXpu3iFq1RSaFFZech9wmylwBOpGP7sTis9OlNAbKzagOmZowSVmHQspLA8x/exec";

    /* ===================== Utils básicos ===================== */
    const norm = s => (s ?? "").toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/\s+/g," ").trim().toUpperCase();

    function mxNow(){ return new Date(new Date().toLocaleString("en-US",{ timeZone:"America/Mexico_City" })); }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function mxISODate(){ const d=mxNow(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function mxISODateTime(){ const d=mxNow(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`; }
    function toNumberSafe(val){ if(val==null) return 0; if(typeof val==="number") return isFinite(val)?val:0; const n=parseFloat(String(val).replace(/[^0-9.-]/g,"")); return isNaN(n)?0:n; }
    function onlyDigits(s){ return String(s ?? "").replace(/\D/g,""); }

    // Normaliza fechas a YYYY-MM-DD (acepta YYYY-MM-DD, DD-MM-YYYY y **DD/MM/YYYY**)
    function normDateYYYYMMDD(s){
      if(!s) return "";
      const t = String(s).trim();

      // YYYY-MM-DD o YYYY/MM/DD
      let m = t.match(/^(\d{4})[-/](\d{2})[-/](\d{2})$/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      // DD-MM-YYYY
      m = t.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;

      // **DD/MM/YYYY**
      m = t.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;

      return t.slice(0,10);
    }

    /* ===================== Datos & Constantes ===================== */
    const URL_DATOS = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/refs/heads/main/datos.json";
    const URL_DIRECCION = "https://raw.githubusercontent.com/alcnca/mapa-semaforo/refs/heads/main/Direccion.json";
    const HEADER_URL = "https://alcnca.github.io/mapa-semaforo/encabezado.png";
    const FOOTER_URL = "https://alcnca.github.io/mapa-semaforo/piepagina.png";

    let HEADER_DATA = null, FOOTER_DATA = null;
    let data = [], direcciones = [];
    let creditosSeleccionados = [];
    let asesorSeleccionado = "", sucursalSeleccionada = "";
    let carteraSeleccionada = "", mostrarModo = "SIN";
    let guardandoAgenda = false;

    // Catálogo local (código -> nombre) y mapeo inverso
    const USER_CODE_TO_NAME = {
      EPMUMU:"EPIFANIO MUÑOZ MUÑOZ",
      AEJIGA:"ABEL EDUARDO JIMENEZ GASPAR",
      GUESDE:"GUSTAVO ESTUDILLO DE LA CRUZ",
      MCRAVI:"MARLEN CECILIA RAMIREZ VILLANUEVA",
      IVLAAR:"IVANI LAINES ARCOS",
      GADZCA:"GASPAR DZIB CAMARA",
      CAMEPE:"CAMERINO MENDOZA PEREZ",
      INANME:"INES ANDRADE MENDEZ",
      RJPESA:"ROBERTO JAVIER PEREZ SANTIAGO",
      AAMODA:"ANDREA ACELA MORGA DÁVILA",
      ADGUHE:"ADAN GUTIÉRREZ HERNÁNDEZ",
      ZYSOIB:"ZOIBETH YANELI SORIANO IBAÑEZ",
      ROVAHU:"ROLANDO VALERIANO HURTADO",
      FAPERO:"FRANCISCO ANTONIO PÉREZ RODRÍGUEZ",
      DASADI:"DANIEL SÁNCHEZ DÍAZ",
      ALCNCA:"ALONSO CANCHE CASTILLO",
      MISADA:"MARIO ISRAEL SALINAS DAMIÁN",
      ALJEHE:"ALFONSO JERÓNIMO HERNÁNDEZ",
      SLPARO:"SANDRA LORENA PACHECO ROBLES"
    };
    const NAME_TO_CODE = Object.fromEntries(Object.entries(USER_CODE_TO_NAME).map(([c,n])=>[norm(n), c]));

    const nombresCoordinadores = {
      DASADI: "DANIEL SÁNCHEZ DÍAZ",
      FAPERO: "FRANCISCO ANTONIO PÉREZ RODRÍGUEZ",
      ALCNCA: "ALONSO CANCHE CASTILLO",
      MCRAVI: "MARLEN CECILIA RAMIREZ VILLANUEVA",
      INANME: "INES ANDRADE MENDEZ",
      MISADA: "MARIO ISRAEL SALINAS DAMIAN",
      OFICINA_CENTRAL: "OFICINA CENTRAL"
    };
    const oficinaCentral = [
      { nombre: "ROBERTO JAVIER PÉREZ SANTIAGO", puesto: "COORDINADOR DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "SANDRA LORENA PACHECO ROBLES", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "ROLANDO VALERIANO HURTADO", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "ANDREA ACELA MORGA DÁVILA", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "GUSTAVO ESTUDILLO DE LA CRUZ", puesto: "ASISTENTE DE RECUPERACIÓN EXTRAJUDICIAL" },
      { nombre: "ALFONSO JERÓNIMO HERNÁNDEZ", puesto: "COORDINADOR DE RECUPERACIÓN PREVENTIVA Y ADMINISTRATIVA" },
      { nombre: "ZOIBETH YANELI SORIANO IBAÑEZ", puesto: "ASISTENTE DE RECUPERACIÓN PREVENTIVA Y ADMINISTRATIVA" },
      { nombre: "ABEL EDUARDO JIMÉNEZ GASPAR", puesto: "ASISTENTE DE RECUPERACIÓN PREVENTIVA Y ADMINISTRATIVA" }
    ];

    /* ===================== Auxiliares de datos ===================== */
    async function blobToDataURL(blob){ return await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }
    async function fetchAsDataURL(url){ try{ const r=await fetch(url,{cache:"force-cache"}); if(!r.ok) throw 0; const b=await r.blob(); return await blobToDataURL(b);}catch{ return null; } }
    function parseDiasSinGestion(raw){ if(raw==null) return null; const s=String(raw).toLowerCase().trim(); const mk=new Set(["","sin gestion","sin gestión","s/g","sg","sen gestion","sin-gestion","sin_gestion"]); if(mk.has(s)) return null; const n=parseInt(s.replace(/[^0-9-]/g,""),10); return isNaN(n)?null:n; }
    const estaSinGestion = raw => parseDiasSinGestion(raw)===null;

    // Helpers de campos
    const valProducto = r => r.producto ?? r.Producto ?? r.product ?? r.Product ?? "";
    const valSocio    = r => r.socio ?? r.Socio ?? r["Num Socio"] ?? r["Numero Socio"] ?? r["Número de Socio"] ?? "";
    const valFase     = r => r.fase ?? r.Fase ?? r.FASE ?? r["Fase del crédito"] ?? r["Fase del credito"] ?? "";
    const valDiasAtr  = r => r["Dias de Atraso"] ?? r["Días de atraso"] ?? r["Dias atraso"] ?? r["Días atraso"] ?? "";
    const valSaldo    = r => toNumberSafe(r["Saldo Total"]);

    // NUEVOS getters para últimas gestiones (acepta variantes de nombres)
    function valRealizoUltimaGestion(r){
      return r["Realizo Ultima Gestion"] ?? r["Realizó Ultima Gestion"] ??
             r["Realizó Última Gestión"] ?? r["Realizo Última Gestión"] ??
             r["Realizo_Ultima_Gestion"] ?? r["Realizo"] ?? r["Realizó"] ?? "";
    }
    function valFechaUltimaGestion(r){
      const raw = r["Fecha Ultima Gestion"] ?? r["Fecha Última Gestión"] ??
                  r["Fecha_Ultima_Gestion"] ?? r["FechaUltimaGestion"] ?? r["UltimaGestionFecha"] ?? "";
      return normDateYYYYMMDD(raw) || "";
    }
    function valTipoGestion(r){
      return r["Tipo de Gestion"] ?? r["Tipo de Gestión"] ??
             r["Tipo_Gestion"] ?? r["TipoGestion"] ?? r["UltimaGestionTipo"] ?? "";
    }

    // Parseo de cuotas
    function parseCuotas(raw){
      if(raw==null) return NaN;
      const s=String(raw).trim().toLowerCase();
      const m=s.match(/^\s*(\d+)\s*(?:\/|\s*de\s*)?\s*(\d+)?\s*$/i);
      if(m) return parseInt(m[1],10);
      const n=parseInt(s.replace(/[^\d-]/g,""),10);
      return isNaN(n)?NaN:n;
    }

    // Fecha de vencimiento (varios alias en el JSON, incluido "Fecha Vencimiento": "dd/mm/yyyy")
    function getFechaVencimientoRaw(r){
      return r.Fecha_Vencimiento ?? r["Fecha_Vencimiento"] ?? r["Fecha de Vencimiento"] ??
             r["Fecha Vencimiento"] ?? r["Vencimiento"] ?? r["fecha_vencimiento"] ?? "";
    }
    function parseVencimientoToDate(r){
      const iso = normDateYYYYMMDD(getFechaVencimientoRaw(r));
      if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return null;
      const [Y,M,D] = iso.split("-").map(n=>parseInt(n,10));
      const d = new Date(`${Y}-${String(M).padStart(2,"0")}-${String(D).padStart(2,"0")}T00:00:00`);
      return isNaN(d.getTime()) ? null : d;
    }

    /* ======= NUEVO: ventana de próximos 30 días ======= */
    function venceEnProximos30Dias(dateObj){
      if(!dateObj) return false;
      const hoy = mxNow();
      const hoy00 = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()); // 00:00 local
      const en30 = new Date(hoy00); en30.setDate(en30.getDate() + 30);
      return dateObj.getTime() >= hoy00.getTime() && dateObj.getTime() <= en30.getTime();
    }

    // Pagos únicos: AGRONEGOCIOS + cuotas=1 + dias_atraso >= 1
    function cumplePagosUnicos(r){
      if(!r) return false;
      const coord = (r.Coordinacion ?? r.coordinacion ?? r["Coordinación"] ?? r["COORDINACION"] ?? r["COORDINACIÓN"] ?? "").toString();
      if (norm(coord) !== "AGRONEGOCIOS") return false;

      const cuotas = parseCuotas(r.Cuotas ?? r.cuotas ?? r["Cuotas"] ?? r["CUOTAS"] ?? r["Num Cuotas"] ?? r["Cuota"] ?? r["Pagos"]);
      if (isNaN(cuotas) || cuotas !== 1) return false;

      const diasAtr = toNumberSafe(valDiasAtr(r));
      return diasAtr >= 1;
    }

    // Pago único por vencer:
    // AGRONEGOCIOS + (sin requerir cuota=1) + fecha de vencimiento en los próximos 30 días (incluyente)
    function cumplePagosUnicosPorVencer(r){
      if(!r) return false;
      const coord = (r.Coordinacion ?? r.coordinacion ?? r["Coordinación"] ?? r["COORDINACION"] ?? r["COORDINACIÓN"] ?? "").toString();
      if (norm(coord) !== "AGRONEGOCIOS") return false;
      const fv = parseVencimientoToDate(r);
      return venceEnProximos30Dias(fv);
    }

    /* ===== Fecha/Hora en letras — CDMX ===== */
    const meses=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
    function numEnEsp(n){ const u=["cero","uno","dos","tres","cuatro","cinco","seis","siete","ocho","nueve","diez","once","doce","trece","catorce","quince","dieciséis","diecisiete","dieciocho","diecinueve","veinte","veintiuno","veintidós","veintitrés","veinticuatro","veinticinco","veintiséis","veintisiete","veintiocho","veintinueve"]; if(n<30)return u[n]; const d=["","","","treinta","cuarenta","cincuenta"]; const dec=Math.floor(n/10),uni=n%10; return uni===0? d[dec]:`${d[dec]} y ${u[uni]}`; }
    function anioEnLetras(y){ const map={2023:"dos mil veintitrés",2024:"dos mil veinticuatro",2025:"dos mil veinticinco",2026:"dos mil veintiséis"}; return map[y]||y.toString(); }
    function ahoraCDMX(){ return mxNow(); }
    function fechaEnLetrasFrom(d){ const h=d.getHours(), m=d.getMinutes(), dd=d.getDate(), mm=d.getMonth(), y=d.getFullYear(); return `${numEnEsp(h)} horas con ${m===0?"cero":numEnEsp(m)} minutos del ${numEnEsp(dd)} de ${meses[mm]} de ${anioEnLetras(y)}`; }

    function getDireccionPorSucursal(sucursal){
      const sNorm=norm(sucursal);
      let found=direcciones.find(d=>norm(d.Nombre_Sucursal)===sNorm);
      if(found) return found;
      found = direcciones.find(d => norm(d.SUCURSAL)===sNorm || norm(d.Sucursal)===sNorm || norm(d.Nombre)===sNorm);
      if(found) return found;
      found = direcciones.find(d => norm(d.Nombre_Sucursal||"").includes(sNorm));
      return found||null;
    }

    function getTextosDocumento(tipo, diasMinimos, asesor, sucursal, firmanteCoord){
      if(tipo==="acta"){
        const dir=getDireccionPorSucursal(sucursal)||{};
        const MUNICIPIO=(dir.MUNICIPIO||"________________").toString().trim();
        const ESTADO=(dir.ESTADO||"________________").toString().trim();
        const NOMBRE_SUCURSAL=(dir.Nombre_Sucursal||sucursal||"________________").toString().trim();
        const DIRECCION=(dir.DIRECCION||"________________").toString().trim();
        const GERENTE=(dir.GERENTE||"__________________________").toString().trim();
        const inicioLocal=ahoraCDMX(), cierreLocal=new Date(inicioLocal.getTime()+30*60000);
        const FECHA_INICIO_LETRAS=fechaEnLetrasFrom(inicioLocal);
        const FECHA_CIERRE_LETRAS=fechaEnLetrasFrom(cierreLocal);

        const intro =
`En el Municipio de ${MUNICIPIO}, ${ESTADO}, en la sucursal de ${NOMBRE_SUCURSAL}, siendo las ${FECHA_INICIO_LETRAS}, estando presentes en las instalaciones de la COOPERATIVA ACREIMEX S.C. de A.P. de R.L. de C.V., con domicilio en ${DIRECCION}, los ciudadanos ${firmanteCoord}, que ostenta el puesto de Coordinador de Recuperación y ${asesor} con el puesto de Asesor de Créditos y Recuperación Individual. Estando presentes en su carácter de testigos los ciudadanos ${GERENTE} que ostenta el puesto de Gerente de Sucursal y ADAN GUTIERREZ HERNANDEZ con el puesto de Gerente de Recuperación Extrajudicial, a quienes les constan los hechos que dan origen al levantamiento de la presente acta.

A continuación, el ciudadano ${firmanteCoord}, narra a los comparecientes los hechos y las razones por las cuales se procede a levantar la presente acta administrativa que consiste en lo siguiente:

En términos de lo dispuesto en el Manual de Gestión de Recuperación de Cartera de la Cooperativa, particularmente en lo relativo a las formalidades para desempeñar las gestiones de cobro (numerales 1.4, 1.5, 2 y 3.14), se establece la obligación del Asesor de Crédito y Recuperación de:

• Dar seguimiento diario y permanente a la cartera asignada a partir de cero días de mora.
• Evidenciar y documentar todas las gestiones de recuperación realizadas en sus diferentes etapas, digitalizándolas en el sistema informático.
• Mantener actualizada la información del socio acreditado, avales o garantes, a fin de facilitar su localización.
• Utilizar los mecanismos autorizados para la gestión de cobranza (llamadas telefónicas, visitas, mensajería SMS o WhatsApp, notificaciones escritas, etc.), siempre con respeto y dentro del horario permitido.
• Registrar en el sistema informático las negociaciones, acuerdos o compromisos de pago establecidos con el socio, así como anexar físicamente al expediente los documentos correspondientes, cuando aplique.`;

        const hechos =
`Hechos:
Se hace constar que el C. ${asesor}, en su calidad de Asesor de Crédito y Recuperación, omitió realizar la gestión de seguimiento a los créditos señalados en la tabla anterior, mismos que presentan un atraso considerable hasta la fecha de la presente acta.

De la revisión efectuada al sistema informático, se constató lo siguiente:

• No existen registros de llamadas, visitas domiciliarias, mensajes, ni cartas de cobranza en los plazos correspondientes, y si bien lo existieran no se encuetran actualizadad
• No se documentaron convenios, acuerdos o compromisos de pago con el socio deudor ni con sus avales.
• Se incumplió con la obligación de prevenir el incremento del atraso, al no dar seguimiento oportuno desde los primeros días de mora.`;

        const faltas =
`Faltas y omisiones detectadas:
La conducta descrita constituye un incumplimiento a lo dispuesto en los numerales:

1.4 Formalidades para desempeñar las gestiones de cobro, al no registrar ni evidenciar convenios, acuerdos o contactos con el socio.
1.5 La recuperación es parte integral del ciclo crediticio, al no aplicar las políticas de prevención y recuperación administrativa.
2. Políticas generales, al no generar ni respaldar las evidencias mínimas de gestión de recuperación (carta invitación, requerimientos, llamadas, mensajería, etc.).
3.14 Responsabilidades del Asesor de Crédito y Recuperación, al no dar seguimiento diario ni documentar en el sistema las gestiones correspondientes.`;

        const determinacion =
`Determinación:
Por lo anterior, se procede a formalizar la presente acta como parte del procedimiento tendiente para
la aplicación de la medida disciplinaria correspondiente a fin de dejar constancia de las faltas y
omisiones cometidas por el Asesor de Crédito y Recuperación, mismas que impactan negativamente
en los indicadores de recuperación de cartera de la sucursal.
Acto posterior, se le concede al socio colaborador el derecho del uso de la palabra con relación a los
hechos que anteceden, manifestando:`;

        const cierre =
`Leída que fue la presente, se ratifica en todas y cada una de sus partes por los comparecientes.
Se concluye la presente acta siendo las ${FECHA_CIERRE_LETRAS}, firmándose al calce y al margen para constancia.`;

        return {
          titulo:"ACTA ADMINISTRATIVA",
          subtitulo:"Se levanta la presente ACTA ADMINISTRATIVA",
          intro, hechos, faltas, determinacion, cierre,
          gerenteSucursal: GERENTE
        };
      }

      // EXHORTO
      const subtitulo = `Motivo: Tener créditos en su cartera con más de ${diasMinimos} días sin gestión`;
      const intro = `Me permito informarle que, derivado de la revisión del seguimiento a los créditos con más de 30 días de atraso de la cartera que usted administra, se han detectado créditos que carecen de gestión y seguimiento en el sistema, por el tiempo indicando en el motivo de la presente y que a continuación se enlistan:`;
      const postTabla = `Derivado de esta situación se detecta su falta de responsabilidad, compromiso, esmero y dedicación en la ejecución de sus responsabilidades; por dicha omisión SE LEVANTA EL PRESENTE EXHORTO para su conocimiento y cumplimiento de dichas actividades, ya que nos ayuda a llevar un sano control de la cartera, manteniendo el menor porcentaje de mora y cuidando el patrimonio de la cooperativa. Para el caso de nueva omisión se tomarán las medidas necesarias de manera inmediata.`;
      return { titulo:"EXHORTO", subtitulo, intro, postTabla };
    }

    /* ===================== Inicio ===================== */
    window.addEventListener("DOMContentLoaded", async () => {
      // Carga de catálogos/recursos externos (si falla, no detenemos la app)
      try{
        const [resDatos, resDir, headerData, footerData] = await Promise.all([
          fetch(URL_DATOS,{cache:"no-store"}), fetch(URL_DIRECCION,{cache:"no-store"}),
          fetchAsDataURL(HEADER_URL), fetchAsDataURL(FOOTER_URL)
        ]);
        data = await resDatos.json();
        const dirJson = await resDir.json();
        if(Array.isArray(dirJson)) direcciones=dirJson;
        else if (dirJson && typeof dirJson==="object"){
          const vals=Object.values(dirJson); direcciones=(vals.length && typeof vals[0]==="object")? vals : [dirJson];
        } else direcciones=[];
        HEADER_DATA=headerData; FOOTER_DATA=footerData;
      }catch(e){
        console.warn("No se pudo cargar datos externos (continuamos solo con Agenda):", e);
      }

      // Poblar coordinadores
      const selCoord=document.getElementById("coordinadorSelect");
      selCoord.innerHTML='<option value="">-- Selecciona --</option>';
      for(const k in nombresCoordinadores){ selCoord.innerHTML+=`<option value="${k}">${nombresCoordinadores[k]}</option>`; }

      document.getElementById("carteraSelect").addEventListener("change", () => {
        carteraSeleccionada = document.getElementById("carteraSelect").value;
        document.getElementById("mostrarDiv").style.display = carteraSeleccionada ? "block" : "none";
        actualizarSucursales();
      });
      document.getElementById("mostrarSelect").addEventListener("change", () => {
        mostrarModo = document.getElementById("mostrarSelect").value;
        document.getElementById("diasMinimosDiv").style.display = (mostrarModo==="TODOS") ? "block" : "none";
        actualizarSucursales();
      });

      selCoord.addEventListener("change", () => {
        const subDiv=document.getElementById("subFirmanteDiv");
        const subSel=document.getElementById("subFirmanteSelect");
        subSel.innerHTML="";
        const valorCoord=selCoord.value;
        if(valorCoord==="OFICINA_CENTRAL"){
          oficinaCentral.forEach(p=> subSel.innerHTML+=`<option value="${p.nombre}">${p.nombre} (${p.puesto})</option>`);
          subDiv.style.display="block";
        } else if (valorCoord){
          subDiv.style.display="none";
          if(valorCoord==="ALCNCA"){
            subDiv.style.display="block";
            subSel.innerHTML+=`<option value="ALCNCA">ALONSO CANCHE CASTILLO (Coordinador)</option>`;
            subSel.innerHTML+=`<option value="IVANI">IVANI ARCOS LAINES (Gestor Regional Zona Maya)</option>`;
          }
        }
        actualizarSucursales();
      });

      document.getElementById("btnAplicar").addEventListener("click", cargarDatos);

      // Abrir modal "Revisar Agenda"
      document.getElementById("btnAbrirAgenda").addEventListener("click", () => {
        document.getElementById("filtroFechaAgenda").value = mxISODate();
        const defaultUser = getUsuarioCreadorCode();
        document.getElementById("filtroUsuarioAgendaInput").value = defaultUser || "";
        document.getElementById("agendaListaTbody").innerHTML = `<tr><td colspan="14" class="text-center text-muted">Ingresa un usuario y pulsa "CARGAR AGENDA".</td></tr>`;
        new bootstrap.Modal(document.getElementById("agendaListaModal")).show();
      });

      document.getElementById("btnCargarHoy").addEventListener("click", cargarAgendasDesdeSheets);
      document.getElementById("filtroFechaAgenda").addEventListener("change", cargarAgendasDesdeSheets);
      document.getElementById("filtroUsuarioAgendaInput").addEventListener("keydown", (ev)=>{
        if(ev.key==="Enter") cargarAgendasDesdeSheets();
      });
    });

    /* ===================== Render principal (Cartera) ===================== */
    function llenarSucursales(lista){
      const selSuc=document.getElementById("sucursalSelect");
      const actual=selSuc.value;
      selSuc.innerHTML='<option value="TODAS">Todas</option>';
      lista.forEach(s=> selSuc.innerHTML+=`<option value="${s}">${s}</option>`);
      if(lista.includes(actual)) selSuc.value=actual; else selSuc.value="TODAS";
    }
    function creditosBaseFiltradosPorCartera(){
      return data.filter(d=>{
        const f = norm(valFase(d));
        if(carteraSeleccionada==="ADMIN") return f.includes("ADMINISTRATIVA");
        if(carteraSeleccionada==="EXTRA") return f.includes("EXTRAJUDICIAL");
        if(carteraSeleccionada==="TODAS") return true;
        return false;
      });
    }
    function actualizarSucursales(){
      const coordSel=document.getElementById("coordinadorSelect").value;
      let base=data.slice();
      if(carteraSeleccionada){ base=creditosBaseFiltradosPorCartera(); } else { llenarSucursales([]); return; }
      if(coordSel && coordSel!=="OFICINA_CENTRAL"){ const target=norm(coordSel); base=base.filter(d=> norm(d.Coordinador)===target ); }

      if(mostrarModo==="SIN"){ base=base.filter(d=> estaSinGestion(d["Dias sin Gestion"])); }
      else if(mostrarModo==="PAGOS_UNICOS"){ base=base.filter(cumplePagosUnicos); }
      else if(mostrarModo==="PAGOS_UNICOS_POR_VENCER"){ base=base.filter(cumplePagosUnicosPorVencer); }

      const sucursales=[...new Set(base.map(d=>d.Sucursal))].filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
      llenarSucursales(sucursales);
    }
    function renderTarjetasPorSucursal(base, sucursal){
      const porAsesor={};
      base.filter(r=> r.Sucursal===sucursal).forEach(r=>{
        const ejecutivo = r.Ejecutivo || "SIN ASESOR";
        (porAsesor[ejecutivo] ||= []).push(r);
      });
      const cont=document.getElementById("contenido");
      const h4=document.createElement("h4"); h4.className="mt-3 mb-3"; h4.textContent=`Sucursal: ${sucursal}`; cont.appendChild(h4);

      const nombresAsesores=Object.keys(porAsesor).sort((a,b)=>a.localeCompare(b,"es"));
      if(nombresAsesores.length===0){
        const alert=document.createElement("div"); alert.className="alert alert-info"; alert.textContent="Sin registros con los criterios seleccionados en esta sucursal."; cont.appendChild(alert); return;
      }

      for(const asesor of nombresAsesores){
        const lista=porAsesor[asesor];
        const total=lista.reduce((acc,r)=> acc + toNumberSafe(r["Saldo Total"]), 0);
        const card=document.createElement("div"); card.className="card mb-3";
        card.innerHTML=`
          <div class="card-header bg-primary text-white">${asesor}</div>
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              Créditos: ${lista.length}<br />
              Total: $${total.toLocaleString("es-MX",{minimumFractionDigits:2})}
            </div>
            <button class="btn btn-warning btn-sm">Vista Previa</button>
          </div>`;
        card.querySelector("button").onclick=()=>{ sucursalSeleccionada=sucursal; mostrarVistaPrevia(asesor, lista); };
        cont.appendChild(card);
      }
    }
    async function cargarDatos(){
      if(!carteraSeleccionada){ alert("Selecciona primero la Cartera a revisar."); return; }
      const sucSel=(document.getElementById("sucursalSelect").value)||"TODAS";
      const diasFiltro=parseInt(document.getElementById("diasMinimos").value)||30;

      let base=creditosBaseFiltradosPorCartera();
      const coordSel=document.getElementById("coordinadorSelect").value;
      if(coordSel && coordSel!=="OFICINA_CENTRAL"){ const target=norm(coordSel); base=base.filter(d=> norm(d.Coordinador)===target ); }

      if(mostrarModo==="SIN"){ base=base.filter(d=> estaSinGestion(d["Dias sin Gestion"])); }
      else if(mostrarModo==="PAGOS_UNICOS"){ base=base.filter(cumplePagosUnicos); }
      else if(mostrarModo==="PAGOS_UNICOS_POR_VENCER"){ base=base.filter(cumplePagosUnicosPorVencer); }
      else{ base=base.filter(d=>{ const dias=parseDiasSinGestion(d["Dias sin Gestion"]); return (dias===null) || (typeof dias==="number" && dias>=diasFiltro); }); }

      const cont=document.getElementById("contenido"); cont.innerHTML="";
      if(sucSel!=="TODAS"){ renderTarjetasPorSucursal(base, sucSel); }
      else{
        const sucursales=[...new Set(base.map(d=>d.Sucursal))].filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
        if(sucursales.length===0){ cont.innerHTML=`<div class="alert alert-info">No se encontraron créditos con los criterios seleccionados.</div>`; return; }
        for(const s of sucursales){ renderTarjetasPorSucursal(base, s); }
      }
    }

    /* ===================== Vista previa + AGENDA ===================== */
    function getResponsableActual(){
      const coordVal = document.getElementById("coordinadorSelect").value;
      if (!coordVal) return "";
      if (coordVal === "OFICINA_CENTRAL") {
        const sub = document.getElementById("subFirmanteSelect").value || "";
        return sub.trim();
      }
      return (nombresCoordinadores[coordVal] || "").trim();
    }
    function getUsuarioCreadorCode(){
      const coordVal = document.getElementById("coordinadorSelect").value; // código si no es OFICINA_CENTRAL
      if (coordVal && coordVal !== "OFICINA_CENTRAL") return coordVal;
      const sub = (document.getElementById("subFirmanteSelect").value || "").trim();
      if (!sub) return "";
      const code = NAME_TO_CODE[norm(sub)] || "";
      return code || "";
    }

    function mostrarVistaPrevia(asesor, creditos){
      asesorSeleccionado=asesor; creditosSeleccionados=creditos;
      const telEjecutivo = (creditos.find(c=>c["Telefono Ejecutivo"])?.["Telefono Ejecutivo"]) ?? (creditos.find(c=>c.Telefono_Ejecutivo)?.Telefono_Ejecutivo) ?? (creditos.find(c=>c.TelefonoEjecutivo)?.TelefonoEjecutivo) ?? "";
      document.getElementById("asesorTitulo").textContent = `Asesor: ${asesor} | Tel: ${telEjecutivo || "s/n"} | Sucursal: ${sucursalSeleccionada}`;

      const tbody=document.getElementById("tablaPreview"); tbody.innerHTML="";
      let total=0;
      creditos.forEach(c=>{
        const saldo=valSaldo(c); total+=saldo;
        const dsgParsed=parseDiasSinGestion(c["Dias sin Gestion"]); const dsgDisplay=(dsgParsed===null)?"SIN GESTIÓN":dsgParsed;
        const fvISO = normDateYYYYMMDD(getFechaVencimientoRaw(c)) || "";

        // NUEVOS: datos de última gestión
        const realizoUG = valRealizoUltimaGestion(c);
        const fechaUG   = valFechaUltimaGestion(c);
        const tipoUG    = valTipoGestion(c);

        // ESTATUS badges
        const badges = [];
        if (cumplePagosUnicos(c))               badges.push('<span class="badge bg-info">PAGO ÚNICO</span>');
        if (cumplePagosUnicosPorVencer(c))      badges.push('<span class="badge bg-danger">VENCE ≤ 30 DÍAS</span>');

        tbody.innerHTML += `
          <tr>
            <td>${c.Linea ?? ""}</td>
            <td>${valProducto(c)}</td>
            <td>${valSocio(c)}</td>
            <td>${c.Nombre ?? ""}</td>
            <td class="text-end">${saldo.toLocaleString("es-MX",{style:"currency",currency:"MXN"})}</td>
            <td class="text-center">${valDiasAtr(c)}</td>
            <td class="text-center">${dsgDisplay}</td>
            <td class="text-center">${valFase(c)}</td>
            <td class="text-center">${fvISO}</td>

            <!-- NUEVAS celdas -->
            <td>${realizoUG || ""}</td>
            <td class="text-center">${fechaUG || ""}</td>
            <td>${tipoUG || ""}</td>
            <!-- /NUEVAS -->

            <td class="text-center estatus-cell">${badges.join(" ")}</td>
          </tr>`;
      });
      document.getElementById("totalPreview").textContent = `TOTAL: ${total.toLocaleString("es-MX",{style:"currency",currency:"MXN"})}`;

      const btnExhorto=document.getElementById("btnGenerarExhorto");
      const btnActa=document.getElementById("btnGenerarActa");
      btnExhorto.onclick=async()=>{ btnExhorto.disabled=true; try{ await generarPDF(asesorSeleccionado, sucursalSeleccionada, creditosSeleccionados, "exhorto"); } finally{ btnExhorto.disabled=false; } };
      btnActa.onclick=async()=>{ btnActa.disabled=true; try{ await generarPDF(asesorSeleccionado, sucursalSeleccionada, creditosSeleccionados, "acta"); } finally{ btnActa.disabled=false; } };

      document.getElementById("btnAgendaPreview").onclick = () => {
        const responsable = getResponsableActual();
        if (!responsable) { alert("Selecciona el 'Coordinador que firma' (o un firmante de Oficina Central)."); return; }
        document.getElementById("agendaTitulo").textContent = `${sucursalSeleccionada} — ${asesorSeleccionado}`;
        document.getElementById("agendaRealizaRO").value = responsable;
        document.getElementById("agendaFechaRegistroRO").value = mxISODateTime();
        new bootstrap.Modal(document.getElementById("agendaModal")).show();
        buildItemsFromPreview();
      };

      new bootstrap.Modal(document.getElementById("vistaPreviaModal")).show();
      marcarAgendadosEnPreview();
    }

    function buildItemsFromPreview(){
      const hoy = mxISODate();
      const tbody = document.getElementById("agendaTbody");
      tbody.innerHTML = "";
      if (!Array.isArray(creditosSeleccionados) || creditosSeleccionados.length===0){
        tbody.innerHTML = `<tr><td colspan="13" class="text-center text-muted">No hay filas en la vista previa.</td></tr>`;
        return;
      }
      creditosSeleccionados.forEach((c, idx) => {
        const saldo = valSaldo(c);
        const dsgParsed = parseDiasSinGestion(c["Dias sin Gestion"]);
        const dsgDisplay = (dsgParsed===null) ? "SIN GESTIÓN" : dsgParsed;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="tdCenter">${idx+1}</td>
          <td class="tdCredito mono">${c.Linea ?? ""}</td>
          <td class="tdSocio mono">${valSocio(c)}</td>
          <td class="tdNombre">${c.Nombre ?? ""}</td>
          <td class="tdSucursal">${sucursalSeleccionada || (c.Sucursal ?? "")}</td>
          <td class="tdAsesor">${asesorSeleccionado || (c.Ejecutivo ?? "")}</td>
          <td class="tdProducto">${valProducto(c)}</td>
          <td class="tdSaldo">${saldo.toLocaleString("es-MX",{style:"currency",currency:"MXN"})}</td>
          <td class="tdDiasAtr tdCenter">${valDiasAtr(c)}</td>
          <td class="tdDiasSinGes tdCenter">${dsgDisplay}</td>
          <td class="tdFase tdCenter">${valFase(c)}</td>
          <td><input type="date" class="form-control form-control-sm fecha-prog" value="${hoy}"></td>
          <td><input type="text" class="form-control form-control-sm obs-prog" maxlength="320" placeholder="Observación (máx. 320)"></td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ===================== PDF ===================== */
    function pageEnv(doc){
      const HEADER={x:50,y:20,w:500,h:80};
      const CONTENT_TOP=HEADER.y+HEADER.h+20, FOOTER_RESERVE=90;
      return {
        CONTENT_TOP, FOOTER_RESERVE,
        marginFor:(left=50,right=50)=>({ top: CONTENT_TOP, left, right, bottom: FOOTER_RESERVE }),
        didDrawPage:()=>{ if(HEADER_DATA){ try{ doc.addImage(HEADER_DATA,"PNG",HEADER.x,HEADER.y,HEADER.w,HEADER.h);}catch{} } },
        ensureSpace:(y,extra=0)=>{ const usableBottom=doc.internal.pageSize.getHeight()-FOOTER_RESERVE; if(y+extra>usableBottom){ doc.addPage(); return CONTENT_TOP; } return y; }
      };
    }
    function addParagraph(doc, text, startY, env, left=50, right=50){
      doc.autoTable({ startY, body:[[text]], theme:"plain", styles:{ fontSize:9, halign:"justify", cellPadding:1.2 }, margin:env.marginFor(left,right), didDrawPage:env.didDrawPage });
      return (doc.lastAutoTable && doc.lastAutoTable.finalY) || startY;
    }
    async function generarPDF(asesor,sucursal,creditos,tipo){
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF("p","pt","a4"); doc.setLineHeightFactor(1.0);
      const env=pageEnv(doc);
      const fecha=mxNow().toLocaleDateString("es-MX",{day:"2-digit",month:"long",year:"numeric"});
      const diasMinimos=parseInt(document.getElementById("diasMinimos").value)||30;

      const inicial=document.getElementById("coordinadorSelect").value;
      const subFirmanteVal=document.getElementById("subFirmanteSelect").value || inicial;
      let firmanteCoord;
      if(inicial==="OFICINA_CENTRAL"){ firmanteCoord=subFirmanteVal||"__________________________"; }
      else if(subFirmanteVal && nombresCoordinadores[subFirmanteVal]){ firmanteCoord=nombresCoordinadores[subFirmanteVal]; }
      else { firmanteCoord=nombresCoordinadores[inicial]||"__________________________"; }

      const textos=getTextosDocumento(tipo, diasMinimos, asesor, sucursal, firmanteCoord);

      let y=env.CONTENT_TOP; const pageWidth=doc.internal.pageSize.getWidth();
      doc.setFontSize(10); doc.text(`Fecha: ${fecha}`,50,y); y+=18;
      doc.setFontSize(14); doc.text(textos.titulo,pageWidth/2,y,{align:"center"}); y+=18;
      doc.setFontSize(12); doc.text(textos.subtitulo||"",pageWidth/2,y,{align:"center"}); y+=24;
      doc.setFontSize(11); doc.text(`Para: ${asesor}`,50,y); y+=14; doc.text(`Sucursal: ${sucursal}`,50,y); y+=10;

      y = addParagraph(doc, textos.intro, y, env, 50, 50);
      y = (doc.lastAutoTable?.finalY || y) + 12; y = env.ensureSpace(y, 10);

      const rows=creditos.map(c=>{
        const dsgParsed=parseDiasSinGestion(c["Dias sin Gestion"]);
        const dsgDisplay=(dsgParsed===null)?"SIN GESTIÓN":dsgParsed;
        const fvISO = normDateYYYYMMDD(getFechaVencimientoRaw(c)) || "";
        return [ c.Linea??"", valProducto(c), valSocio(c), c.Nombre??"", toNumberSafe(c["Saldo Total"]).toLocaleString("es-MX",{style:"currency",currency:"MXN"}), valDiasAtr(c), dsgDisplay, valFase(c), fvISO ];
      });

      doc.autoTable({
        startY:y,
        head:[["Crédito","Producto","Socio","Nombre del Socio","Saldo","Días atraso","Días sin gestión","Fase","Venc."]],
        body:rows,
        styles:{ fontSize:8, cellPadding:1.3, lineWidth:.1, valign:"middle" },
        headStyles:{ fillColor:[0,0,0], textColor:[255,255,255], halign:"center", fontSize:8 },
        columnStyles:{ 0:{halign:"center"},1:{halign:"center"},2:{halign:"left"},3:{halign:"left"},4:{halign:"right"},5:{halign:"center"},6:{halign:"center"},7:{halign:"center"},8:{halign:"center"} },
        margin:env.marginFor(40,40),
        didDrawPage:env.didDrawPage
      });
      y=(doc.lastAutoTable?.finalY || y)+8; y=env.ensureSpace(y,10);
      doc.setFontSize(11);
      const totalImporte=creditos.reduce((acc,c)=> acc + toNumberSafe(c["Saldo Total"]), 0);
      doc.text(`TOTAL: ${totalImporte.toLocaleString("es-MX",{style:"currency",currency:"MXN"})}`, pageWidth/2, y, {align:"center"}); y+=12;

      if(tipo==="acta"){
        y=addParagraph(doc,textos.hechos,y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+6;
        y=addParagraph(doc,textos.faltas,y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+6;
        y=addParagraph(doc,textos.determinacion,y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+96;
        y=addParagraph(doc,textos.cierre,y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+18;
      } else {
        y=addParagraph(doc,textos.postTabla,y,env,50,50); y=(doc.lastAutoTable?.finalY||y)+18;
        y=env.ensureSpace(y,120); doc.setFontSize(11);
        doc.text("Atentamente,", pageWidth/2, y, {align:"center"}); y+=30;
        doc.text("_______________________________", pageWidth/2, y, {align:"center"}); y+=14;
        doc.text("Coordinación de Recuperación", pageWidth/2, y, {align:"center"});
      }
      const pageCount=doc.getNumberOfPages();
      for(let i=1;i<=pageCount;i++){
        doc.setPage(i);
        const pageW=doc.internal.pageSize.getWidth(), pageH=doc.internal.pageSize.getHeight();
        const footerWidth=500, footerHeight=50, footerX=(pageW-footerWidth)/2, footerY=pageH-footerHeight-20;
        if(FOOTER_DATA){ try{ doc.addImage(FOOTER_DATA,"PNG",footerX,footerY,footerWidth,footerHeight);}catch{} }
        doc.setFontSize(9); doc.text(`Página ${i} de ${pageCount}`, pageW-60, footerY-6, {align:"right"});
      }
      const nombreArchivo=(tipo==="acta"?"ACTA_ADMINISTRATIVA":"EXHORTO");
      doc.save(`${nombreArchivo}_${asesor.replace(/ /g,"_")}_${norm(sucursal).replace(/[^A-Z0-9_]/g,"")}.pdf`);
    }

    /* ===================== GAS API ===================== */
    async function guardarAgendaEnSheet(payload){
      const res = await fetch(GAS_API_URL, { method:"POST", headers:{ "Content-Type":"text/plain" }, body: JSON.stringify(payload) });
      const j = await res.json(); if(!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`); return j;
    }
    async function consultarAgendaEnSheet({fecha=null, desde=null, usuario=null, q=null} = {}){
      const u = new URL(GAS_API_URL);
      u.searchParams.set("action","list");
      if (fecha)   u.searchParams.set("fecha", fecha); // yyyy-mm-dd
      if (desde)   u.searchParams.set("desde", desde); // yyyy-mm-dd
      if (usuario) u.searchParams.set("usuario", usuario); // código
      if (q)       u.searchParams.set("q", q);
      const res = await fetch(u.toString(), { method:"GET", cache:"no-store" });
      const j = await res.json(); if(!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`); return j.items || [];
    }

    /* ===================== Guardar agenda ===================== */
    document.getElementById("btnGuardarAgenda").addEventListener("click", async () => {
      if (guardandoAgenda) return;
      guardandoAgenda = true;

      const btn = document.getElementById("btnGuardarAgenda");
      const oldLabel = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'Guardando…';

      try{
        const responsable = getResponsableActual();
        if (!responsable) throw new Error("Selecciona el 'Coordinador que firma'.");

        const creadoPor = getUsuarioCreadorCode(); // CÓDIGO automáticamente
        if (!creadoPor) throw new Error("No se pudo determinar el 'usuario que crea'. Selecciona un firmante con usuario asignado.");

        const filas = document.querySelectorAll("#agendaTbody tr");
        if (!filas.length) throw new Error("No hay filas para guardar.");

        const items=[]; let algunaFecha=null;
        filas.forEach(tr=>{
          const obj={
            fecha_programada: tr.querySelector(".fecha-prog")?.value || "",
            credito: tr.querySelector(".tdCredito")?.innerText.trim() || "",
            socio:   tr.querySelector(".tdSocio")?.innerText.trim() || "",
            nombre:  tr.querySelector(".tdNombre")?.innerText.trim() || "",
            sucursal: tr.querySelector(".tdSucursal")?.innerText.trim() || "",
            asesor:   tr.querySelector(".tdAsesor")?.innerText.trim() || "",
            producto: tr.querySelector(".tdProducto")?.innerText.trim() || "",
            saldo:    tr.querySelector(".tdSaldo")?.innerText.trim() || "",
            dias_atraso: tr.querySelector(".tdDiasAtr")?.innerText.trim() || "",
            dias_sin_gestion: tr.querySelector(".tdDiasSinGes")?.innerText.trim() || "",
            fase: tr.querySelector(".tdFase")?.innerText.trim() || "",
            observaciones: tr.querySelector(".obs-prog")?.value || "",
            responsable
          };
          if(!algunaFecha && obj.fecha_programada) algunaFecha=obj.fecha_programada;
          items.push(obj);
        });
        if(!algunaFecha) throw new Error("Falta la 'Fecha programada' en al menos una fila.");

        const out = await guardarAgendaEnSheet({ creado_por: creadoPor, items, responsable });
        alert(`✅ Guardado. Insertadas: ${out.inserted ?? 0}. Omitidas por duplicado: ${out.skipped ?? 0}.`);
        bootstrap.Modal.getInstance(document.getElementById("agendaModal"))?.hide();
      }catch(e){
        alert("❌ Error al guardar en Sheets: " + (e.message || e));
      }finally{
        guardandoAgenda=false; btn.disabled=false; btn.innerHTML=oldLabel;
      }
    });

    /* ===================== Revisar Agenda (filtro: FECHA + CREADOR texto) ===================== */
    async function cargarAgendasDesdeSheets(){
      try{
        const fecha = document.getElementById("filtroFechaAgenda").value || mxISODate();
        const usuario = (document.getElementById("filtroUsuarioAgendaInput").value || "").trim().toUpperCase();

        if(!usuario){
          alert("Ingresa el usuario (código) creador, ej. ALCNCA.");
          document.getElementById("agendaListaTbody").innerHTML = `<tr><td colspan="14" class="text-center text-muted">Ingresa un usuario.</td></tr>`;
          return;
        }

        // Llamada al backend con filtros
        let items = await consultarAgendaEnSheet({ fecha, usuario });

        // Filtros defensivos en el frontend (por si el backend no los aplica)
        items = (items || []).filter(r =>
          norm((r.creado_por||"")) === norm(usuario) &&
          normDateYYYYMMDD(r.fecha_programada) === fecha
        );

        const tbody = document.getElementById("agendaListaTbody");
        tbody.innerHTML = "";

        if (!items.length){
          tbody.innerHTML = `<tr><td colspan="14" class="text-center text-muted">Sin resultados.</td></tr>`;
          return;
        }

        items.sort((a,b) =>
          (a.fecha_programada||"").localeCompare(b.fecha_programada||"") ||
          (a.sucursal||"").localeCompare(b.sucursal||"") ||
          (a.asesor||"").localeCompare(b.asesor||"")
        );

        items.forEach((r,i)=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="text-center">${i+1}</td>
            <td class="mono">${r.fecha_registro || r.fecha_registro_iso || ""}</td>
            <td class="text-center">${normDateYYYYMMDD(r.fecha_programada) || ""}</td>
            <td>${r.credito || ""}</td>
            <td class="mono">${r.socio || ""}</td>
            <td>${r.nombre || ""}</td>
            <td>${r.sucursal || ""}</td>
            <td>${r.asesor || ""}</td>
            <td>${r.producto || ""}</td>
            <td class="tdSaldo">${r.saldo || ""}</td>
            <td class="tdCenter">${r.dias_atraso || ""}</td>
            <td class="tdCenter">${r.dias_sin_gestion || ""}</td>
            <td class="tdCenter">${r.fase || ""}</td>
            <td>${r.observaciones || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      }catch(err){
        alert("Error cargando agenda desde Sheets: " + (err.message || err));
      }
    }

    /* ===================== Marca "AGENDADO" en la vista previa ===================== */
    async function marcarAgendadosEnPreview() {
      try {
        const hoyISO = mxISODate();
        const ag = await consultarAgendaEnSheet({ desde: hoyISO }); // desde hoy
        const setCredAgendados = new Set(
          (ag || [])
            .filter(r => r.credito && r.fecha_programada)
            .map(r => onlyDigits(r.credito))
            .filter(Boolean)
        );

        const rows = document.querySelectorAll("#tablaPreview tr");
        rows.forEach(row => {
          const credito = onlyDigits(row.children?.[0]?.innerText || "");
          const estTd = row.querySelector(".estatus-cell");
          if (!estTd) return;
          if (credito && setCredAgendados.has(credito)) {
            estTd.innerHTML += (estTd.innerHTML ? " " : "") + '<span class="badge bg-success">AGENDADO</span>';
          }
        });
      } catch (e) {
        console.warn("No se pudo marcar AGENDADO:", e);
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
