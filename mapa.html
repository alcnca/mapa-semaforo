<html>
<head>
  <meta charset="utf-8">
  <title>Mapa Sem치foro</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; margin: 0; }

    .leaflet-tooltip {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    .sucursal-label {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      text-shadow: none !important;
      color: black !important;
      font-size: 10px;
      font-weight: bold;
    }

    .neon-marker {
      width: 10px;
      height: 10px;
      background: red;
      border-radius: 50%;
      box-shadow: 0 0 3px red, 0 0 6px red;
      animation: pulse 1.5s infinite;
      border: 1px solid white;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 1px red, 0 0 3px red; }
      50% { box-shadow: 0 0 5px red, 0 0 10px red; }
      100% { box-shadow: 0 0 1px red, 0 0 3px red; }
    }

    .filtros {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 5px;
      border-radius: 5px;
      z-index: 1000;
    }

    select { margin-right: 5px; }
  </style>
</head>
<body>

<div class="filtros">
  <label>Coordinador: 
    <select id="filtroCoordinador"><option value="TODOS">Todos</option></select>
  </label>
  <label>Sucursal: 
    <select id="filtroSucursal"><option value="TODAS">Todas</option></select>
  </label>
  <label>Ejecutivo: 
    <select id="filtroEjecutivo"><option value="TODOS">Todos</option></select>
  </label>
  <label>Banda: 
    <select id="filtroBanda"><option value="TODAS">Todas</option></select>
  </label>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const dataUrl = 'datos.json';
  let userLat = null, userLng = null, data = [];
  let markers = [];
  let map;

  navigator.geolocation.getCurrentPosition(position => {
    userLat = position.coords.latitude;
    userLng = position.coords.longitude;
  }, () => {
    console.warn("Ubicaci칩n no permitida o no disponible");
  });

  fetch(dataUrl)
    .then(res => res.json())
    .then(allData => {
      data = allData;
      initMap();
      loadInitialFilters();
      refreshMap();
    });

  function initMap() {
    map = L.map('map').setView([17.05, -96.72], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '춸 OSM'
    }).addTo(map);

    if (userLat && userLng) {
      L.marker([userLat, userLng], {
        icon: L.icon({
          iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
          iconSize: [30, 30],
          iconAnchor: [15, 30]
        })
      }).addTo(map).bindPopup("Tu ubicaci칩n");
    }
  }

  function getIcon(a, d) {
    const n = parseInt(d);
    if (n === 88 || n === 89) {
      return L.divIcon({ className: 'neon-marker', iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] });
    }
    const url = (a.trim().toUpperCase() === 'SI')
      ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png'
      : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png';
    return L.icon({
      iconUrl: url,
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
  }

  const selCoord = document.getElementById('filtroCoordinador'),
        selSuc   = document.getElementById('filtroSucursal'),
        selEje   = document.getElementById('filtroEjecutivo'),
        selBanda = document.getElementById('filtroBanda');

  function loadInitialFilters() {
    const coordinadores = [...new Set(data.map(r => r.Coordinador))];
    coordinadores.forEach(c => selCoord.append(new Option(c, c)));

    updateSucursales('TODOS');
    updateEjecutivos('TODOS', 'TODAS');
    updateBandas('TODOS', 'TODAS', 'TODOS');
  }

  function updateSucursales(coord) {
    selSuc.innerHTML = '<option value="TODAS">Todas</option>';
    let filtrado = coord === 'TODOS' ? data : data.filter(r => r.Coordinador === coord);
    const sucursales = [...new Set(filtrado.map(r => r.Sucursal))];
    sucursales.forEach(s => selSuc.append(new Option(s, s)));
  }

  function updateEjecutivos(coord, sucursal) {
    selEje.innerHTML = '<option value="TODOS">Todos</option>';
    let filtrado = data;
    if (coord !== 'TODOS') filtrado = filtrado.filter(r => r.Coordinador === coord);
    if (sucursal !== 'TODAS') filtrado = filtrado.filter(r => r.Sucursal === sucursal);
    const ejecutivos = [...new Set(filtrado.map(r => r.Ejecutivo))];
    ejecutivos.forEach(e => selEje.append(new Option(e, e)));
  }

  function updateBandas(coord, sucursal, ejecutivo) {
    selBanda.innerHTML = '<option value="TODAS">Todas</option>';
    let filtrado = data;
    if (coord !== 'TODOS') filtrado = filtrado.filter(r => r.Coordinador === coord);
    if (sucursal !== 'TODAS') filtrado = filtrado.filter(r => r.Sucursal === sucursal);
    if (ejecutivo !== 'TODOS') filtrado = filtrado.filter(r => r.Ejecutivo === ejecutivo);
    const bandas = [...new Set(filtrado.map(r => r.Banda))];
    bandas.forEach(b => selBanda.append(new Option(b, b)));
  }

  function refreshMap() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const fc = selCoord.value,
          fs = selSuc.value,
          fe = selEje.value,
          fb = selBanda.value;

    data.forEach(r => {
      if ((fc !== 'TODOS' && r.Coordinador !== fc) ||
          (fs !== 'TODAS' && r.Sucursal !== fs) ||
          (fe !== 'TODOS' && r.Ejecutivo !== fe) ||
          (fb !== 'TODAS' && r.Banda !== fb)) return;

      const lat = parseFloat(r.Latitud), lng = parseFloat(r.Longitud);
      if (!lat || !lng) return;

      const mk = L.marker([lat, lng], { icon: getIcon(r.Aceptacion, r['Dias de Atraso']) }).addTo(map);

      mk.bindPopup(`
        <strong>${r.Sucursal}</strong><br>
        Banda: ${r.Banda}<br>
        Coordinador: ${r.Coordinador}<br>
        Aceptaci칩n: ${r.Aceptacion}<br>
        D칤as sin gesti칩n: ${r['Dias sin Gestion']}<br>
        L칤nea: ${r.Linea}<br>
        Nombre: ${r.Nombre}<br>
        Saldo: $${r['Saldo Total']}<br>
        % Pagado: ${r['Porcentaje Pagado']}%<br>
        Producto: ${r.Producto}<br>
        D칤as de atraso: ${r['Dias de Atraso']}<br>
        Ejecutivo: ${r.Ejecutivo}<br><br>
        <a href="https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${lat},${lng}" target="_blank">
          游늸 Ir con Google Maps
        </a>
      `);

      mk.bindTooltip(r.Sucursal, {
        permanent: true,
        direction: 'top',
        offset: [0, -10],
        className: 'sucursal-label'
      });

      markers.push(mk);
    });

    if (markers.length > 0) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  }

  // Eventos
  selCoord.addEventListener('change', () => {
    updateSucursales(selCoord.value);
    updateEjecutivos(selCoord.value, 'TODAS');
    updateBandas(selCoord.value, 'TODAS', 'TODOS');
    refreshMap();
  });

  selSuc.addEventListener('change', () => {
    updateEjecutivos(selCoord.value, selSuc.value);
    updateBandas(selCoord.value, selSuc.value, 'TODOS');
    refreshMap();
  });

  selEje.addEventListener('change', () => {
    updateBandas(selCoord.value, selSuc.value, selEje.value);
    refreshMap();
  });

  selBanda.addEventListener('change', refreshMap);
</script>
</body>
</html>
